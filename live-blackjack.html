<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Live ‚Äî Mini Blackjack (Real Felt + Banner + SFX)</title>
<meta name="theme-color" content="#073d2b"/>
<style>
  :root{
    --felt:#0c7a4a; --felt-deep:#075c39; --felt-dark:#063e29;
    --rail:#3a2a1c; --brass:#e7c45a;
    --ink:#f5fff8; --mut:#cfe9dc; --ring:rgba(255,255,255,.08);
    --chip-red:#d95757; --chip-green:#6bd37e; --chip-blue:#51a0ff; --chip-black:#222; --chip-purple:#ab78ff; --chip-gold:#ffd86a;
    --g1:#ffd86a; --g2:#f3b54d;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0;color:var(--ink);
    background: radial-gradient(1800px 1200px at 50% -20%, #154f38 0%, #0a3a27 50%, #031b13 100%);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    display:flex;align-items:center;justify-content:center;padding:18px;
  }
  a.back{position:fixed;left:12px;top:12px;z-index:120;text-decoration:none;background:rgba(0,0,0,.45);padding:8px 12px;border-radius:10px;color:#fff;font-weight:800;border:1px solid rgba(255,255,255,.15);backdrop-filter:blur(6px)}
  .wrap{width:min(1180px,98vw)}
  .card{
    position:relative;border-radius:26px;overflow:hidden;
    box-shadow:0 30px 90px rgba(0,0,0,.6), inset 0 0 120px rgba(0,0,0,.35);
    background: radial-gradient(900px 520px at 50% 0%, var(--felt) 0%, var(--felt-deep) 70%, var(--felt-dark) 100%);
  }

  /* Rail & decorative bits */
  .rail{position:absolute; inset:-36px -36px auto -36px; height:110px; border-radius:34px 34px 0 0;
    background: radial-gradient(1200px 200px at 50% 10%, rgba(0,0,0,.5), transparent 70%), linear-gradient(180deg, #623f26 0%, #3e2b1c 35%, #2e1f14 100%);
    box-shadow: inset 0 -12px 30px rgba(0,0,0,.6), 0 10px 30px rgba(0,0,0,.5); z-index:2 }
  .rim{position:absolute; inset:-2px; border-radius:28px; box-shadow:inset 0 0 0 2px rgba(0,0,0,.5), inset 0 0 0 8px rgba(0,0,0,.18)}
  .rim::after{content:""; position:absolute; inset:10px; border-radius:22px; box-shadow:inset 0 0 0 2px rgba(0,0,0,.35), inset 0 0 0 4px rgba(255,255,255,.04)}
  .bar{position:relative; z-index:3; margin-top:18px; display:flex; justify-content:space-between; align-items:center; gap:8px; padding:14px 20px; color:#fff}
  h1{margin:0;font-size:20px;font-weight:900;letter-spacing:.8px;text-transform:uppercase;text-shadow:0 2px 12px rgba(0,0,0,.5)}
  .pill{padding:8px 12px;border-radius:999px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.15);color:#fdfae5;font-weight:800;display:flex;gap:6px;align-items:center}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{border:0;border-radius:12px;padding:10px 14px;font-weight:900;cursor:pointer;background:linear-gradient(to right,var(--g1),var(--g2));color:#2d2200;box-shadow:0 0 18px rgba(255,216,106,.4), inset 0 -3px 0 rgba(0,0,0,.35);transition:transform .12s ease, filter .12s ease}
  .btn:disabled{filter:grayscale(.7) brightness(.75);cursor:not-allowed}
  .btn.ghost{background:#2b2b2b;color:#fff;box-shadow:inset 0 -3px 0 rgba(0,0,0,.45)}
  .btn.warn{background:linear-gradient(90deg,#ffb86c,#ff6e6e);color:#2b0b0b;box-shadow:0 0 18px rgba(255,140,120,.45), inset 0 -3px 0 rgba(0,0,0,.35)}

  /* Status/labels no-overlap fix */
  .status{
    position: relative; z-index: 6; min-height: 28px;
    margin: 6px 0 10px; font-weight:900; text-align:center; letter-spacing:.25px;
    text-shadow:0 2px 10px rgba(0,0,0,.55);
  }
  .status.win{color:#aef7c1} .status.lose{color:#ffb3be} .status.push{color:#d9e7ff}
  .area{position:relative; z-index:2; padding-bottom:6px}
  .hand{position:relative;display:flex;gap:10px;min-height:114px;justify-content:center;align-items:center}
  .tag{position:absolute;top:-12px;left:50%;transform:translateX(-50%);z-index:5;pointer-events:none;color:#fff;font-weight:900;text-shadow:0 2px 10px rgba(0,0,0,.5)}
  .score{color:#ffeaa1;font-weight:900;text-shadow:0 0 8px rgba(0,0,0,.4);margin:6px 0;text-align:center}
  .controls{position: relative; z-index: 1; margin: 14px 0 8px; display:flex;flex-wrap:wrap;justify-content:center;gap:8px}

  /* Table layout */
  .table{position:relative; margin:0 16px 16px; padding:130px 16px 20px; border-radius:20px; outline:1px solid rgba(255,255,255,.05)}
  .engrave{position:absolute; inset:90px 0 0 0; pointer-events:none; z-index:1; opacity:.9}
  .engrave svg{ width:100%; height:auto; display:block; filter: drop-shadow(0 2px 0 rgba(0,0,0,.25)); }
  .rack{position:absolute; top:72px; left:50%; transform:translateX(-50%); width:min(560px,90%); height:64px; border-radius:16px; z-index:3; background:linear-gradient(180deg, #7f5a2e 0%, #5a3e21 60%, #2e2015 100%); border:1px solid rgba(0,0,0,.45); box-shadow:inset 0 6px 0 rgba(255,255,255,.08), inset 0 -10px 16px rgba(0,0,0,.5), 0 12px 24px rgba(0,0,0,.4); display:flex; align-items:center; justify-content:center; gap:8px; padding:6px 10px}
  .rack .slot{width:64px;height:46px;border-radius:10px;background:linear-gradient(180deg,#0a0f13,#182026);box-shadow:inset 0 6px 10px rgba(0,0,0,.7), inset 0 -2px 0 rgba(255,255,255,.06);display:grid;place-items:center}
  .stackChip{width:22px;height:22px;border-radius:50%;box-shadow:0 2px 0 rgba(0,0,0,.5), inset 0 0 0 3px rgba(255,255,255,.9)}

  /* Betting & shoe */
  .zone{display:grid;grid-template-columns:1fr 280px;gap:14px;margin-top:10px;z-index:2;position:relative}
  .betting{display:grid;gap:10px;border-radius:14px;padding:12px;background:linear-gradient(180deg,rgba(0,0,0,.25),rgba(0,0,0,.35));outline:1px solid rgba(255,255,255,.1)}
  .bet-circle{height:96px;border-radius:120px;border:2px dashed rgba(255,221,130,.65);display:grid;place-items:center;font-weight:900;color:#fffdf2;background:rgba(0,0,0,.22);text-shadow:0 2px 10px rgba(0,0,0,.6)}
  .chips{display:flex;gap:10px;flex-wrap:wrap}
  .chip{width:58px;height:58px;border-radius:50%;display:grid;place-items:center;cursor:pointer;font-weight:900;background:radial-gradient(circle at 50% 35%, rgba(255,255,255,.25), transparent 60%), conic-gradient(from 0deg, rgba(255,255,255,.95) 0 10deg, var(--c) 10deg 35deg, rgba(255,255,255,.95) 35deg 45deg, var(--c) 45deg 70deg, rgba(255,255,255,.95) 70deg 80deg, var(--c) 80deg 360deg); color:#2d2200;border:3px solid rgba(0,0,0,.5);box-shadow:0 10px 24px rgba(0,0,0,.45), inset 0 0 0 4px rgba(0,0,0,.25);transition:transform .12s ease}
  .chip:active{transform:translateY(1px) scale(.98)}
  .chip span{display:block;background:#fff;border-radius:999px;padding:3px 8px;font-size:14px;border:2px solid rgba(0,0,0,.12)}
  .shoe{position:relative;height:124px;border-radius:14px;padding:12px;background:linear-gradient(180deg,rgba(0,0,0,.25),rgba(0,0,0,.35));outline:1px solid rgba(255,255,255,.1)}
  .stack{position:absolute;right:20px;top:16px;display:flex;flex-direction:column-reverse;gap:2px;align-items:flex-end}
  .stack div{width:46px;height:64px;border-radius:8px;background:linear-gradient(180deg,#0f1b2e,#0b1423);outline:1px solid rgba(255,255,255,.06);box-shadow:0 6px 16px rgba(0,0,0,.45);transform:rotate(-6deg)}
  .cut{position:absolute;right:88px;top:20px;width:10px;height:70px;border-radius:3px;background:linear-gradient(180deg,#ffc96a,#f1a24b);opacity:.7}
  .sub{color:var(--mut);font-weight:700}

  /* Cards */
  .playing{position:relative;width:74px;height:102px;transform-style:preserve-3d;perspective:800px}
  .card3d{position:absolute;inset:0;border-radius:10px;backface-visibility:hidden;display:grid;place-items:center;font-weight:900;box-shadow:0 12px 30px rgba(0,0,0,.45), inset 0 -2px 0 rgba(0,0,0,.2)}
  .front{background:radial-gradient(200px 140px at 50% -20%,#fff,#f3f6fb 45%,#dbe4f5 100%);outline:2px solid #e7ecf7;color:#1a2050;font-size:22px}
  .back{transform:rotateY(180deg);background:repeating-linear-gradient(45deg,#093a27 0 6px,#0a4a30 6px 12px);outline:1px solid rgba(255,255,255,.1); color:#7cbcff; font-size:12px; letter-spacing:1px}
  .is-back .front{transform:rotateY(180deg)} .is-back .back{transform:rotateY(0)} .flip{transition: transform .5s cubic-bezier(.22,.8,.24,1)}

  /* FX */
  .fx{position:absolute;inset:0;pointer-events:none;overflow:visible;z-index:5}
  .fly{position:absolute;width:74px;height:102px;border-radius:10px;will-change:transform;transform:translate3d(0,0,0);background:linear-gradient(180deg,#0e1a3a,#0a1329);outline:1px solid var(--ring);box-shadow:0 12px 30px rgba(0,0,0,.45);transition: transform .48s cubic-bezier(.22,.8,.24,1), opacity .2s ease}
  .spark{position:absolute;width:8px;height:8px;border-radius:2px;background:#fff;box-shadow:0 0 18px rgba(255,255,255,.7);opacity:.9}

  /* Pulses & flashes for table accent on outcome */
  @keyframes flashWin {0%,100%{box-shadow:inset 0 0 0 rgba(0,0,0,0)} 40%{box-shadow:inset 0 0 200px rgba(174,247,193,.25)}}
  @keyframes flashLose {0%,100%{box-shadow:inset 0 0 0 rgba(0,0,0,0)} 40%{box-shadow:inset 0 0 200px rgba(255,100,120,.18)}}
  @keyframes flashPush {0%,100%{box-shadow:inset 0 0 0 rgba(0,0,0,0)} 40%{box-shadow:inset 0 0 200px rgba(160,200,255,.18)}}
  .table.win  { animation: flashWin  .8s ease }
  .table.lose { animation: flashLose .8s ease }
  .table.push { animation: flashPush .8s ease }

  /* Outcome Banner */
  .outcome{position:absolute; inset:0; pointer-events:none; display:grid; place-items:center; opacity:0; transform:scale(.98); transition:opacity .25s ease, transform .25s ease; z-index: 8;}
  .outcome.show{ opacity:1; transform:scale(1); }
  .outcome-wrap{padding:18px 26px; border-radius:18px;background: rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.15); box-shadow:0 30px 90px rgba(0,0,0,.6); text-align:center; backdrop-filter: blur(4px); animation: popIn .5s cubic-bezier(.22,.8,.24,1);}
  .outcome-title{font-weight:1000; font-size: clamp(28px, 4.4vw, 52px); letter-spacing:.06em; line-height:1; text-shadow: 0 6px 22px rgba(0,0,0,.6);}
  .outcome-sub{margin-top:6px; font-weight:800; font-size: clamp(13px, 1.8vw, 18px); color:#fff; opacity:.9}
  .outcome.win  .outcome-title{ color:#aef7c1; text-shadow:0 0 24px rgba(80,220,150,.55) }
  .outcome.lose .outcome-title{ color:#ffb3be; text-shadow:0 0 24px rgba(255,120,140,.55) }
  .outcome.push .outcome-title{ color:#d9e7ff; text-shadow:0 0 24px rgba(160,200,255,.55) }
  @keyframes popIn{ 0%{transform:scale(.85); opacity:0} 60%{transform:scale(1.03); opacity:1} 100%{transform:scale(1)} }

  @media(max-width:820px){.zone{grid-template-columns:1fr} .status{margin:8px 0 12px} .controls{margin:16px 0 10px}}
</style>
</head>
<body>
  <a class="back" href="index.html">‚Üê Back</a>
  <div class="wrap">
    <div class="card table" id="table">
      <div class="rim"></div>
      <div class="rail"></div>

      <div class="bar">
        <h1>Mini Blackjack ‚Äî Live</h1>
        <div class="row">
          <div class="pill">Bank: <b id="bankVal">100</b></div>
          <div class="pill">Bet: <b id="betVal">0</b></div>
          <button class="btn ghost" id="muteBtn" title="Toggle SFX">üîä SFX</button>
          <button class="btn ghost" id="ambBtn" title="Toggle ambience">üéß Ambience</button>
        </div>
      </div>

      <!-- Decorative brass arcs -->
      <div class="engrave">
        <svg viewBox="0 0 1200 520" preserveAspectRatio="none">
          <path d="M60,340 A540,540 0 0,1 1140,340" fill="none" stroke="rgba(231,196,90,.9)" stroke-width="3"/>
          <path d="M130,360 A470,470 0 0,1 1070,360" fill="none" stroke="rgba(231,196,90,.6)" stroke-width="2"/>
          <path d="M200,380 A400,400 0 0,1 1000,380" fill="none" stroke="rgba(231,196,90,.45)" stroke-width="2"/>
          <defs><path id="txt" d="M200,380 A400,400 0 0,1 1000,380"/></defs>
          <text font-family="ui-sans-serif,system-ui" font-weight="800" font-size="16" fill="rgba(255,245,210,.9)" letter-spacing="3">
            <textPath href="#txt" startOffset="50%" text-anchor="middle">DEALER   ‚Ä¢   PLAYER   ‚Ä¢   GOOD LUCK</textPath>
          </text>
        </svg>
      </div>

      <!-- Chip rack -->
      <div class="rack">
        <div class="slot"><div class="stackChip" style="background:var(--chip-red)"></div></div>
        <div class="slot"><div class="stackChip" style="background:var(--chip-green)"></div></div>
        <div class="slot"><div class="stackChip" style="background:var(--chip-blue)"></div></div>
        <div class="slot"><div class="stackChip" style="background:var(--chip-purple)"></div></div>
        <div class="slot"><div class="stackChip" style="background:var(--chip-gold)"></div></div>
        <div class="slot"><div class="stackChip" style="background:var(--chip-black)"></div></div>
      </div>

      <div class="table-inner" style="position:relative; padding:8px 16px 16px;">
        <div id="status" class="status">Place a bet, then Deal</div>

        <!-- Dealer -->
        <div class="area">
          <div class="tag">DEALER</div>
          <div class="hand" id="dealerHand"></div>
          <div class="score" id="dealerScore">‚Äî</div>
        </div>

        <!-- Player -->
        <div class="area">
          <div class="tag">PLAYER</div>
          <div class="hand" id="playerHand"></div>
          <div class="score" id="playerScore">‚Äî</div>
        </div>

        <!-- Controls -->
        <div class="controls">
          <button class="btn" id="dealBtn">Deal</button>
          <button class="btn" id="hitBtn" disabled>Hit</button>
          <button class="btn ghost" id="standBtn" disabled>Stand</button>
          <button class="btn warn" id="doubleBtn" disabled>Double</button>
          <button class="btn ghost" id="rebetBtn">Rebet</button>
          <button class="btn ghost" id="betMaxBtn">Bet Max</button>
          <button class="btn ghost" id="newShoeBtn">Shuffle Shoe</button>
        </div>

        <!-- Voucher -->
        <div class="code" id="codeBox" style="display:none;margin:8px auto 0;text-align:center;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;letter-spacing:.6px;padding:10px 12px;border-radius:12px;background:rgba(0,0,0,.25);outline:1px dashed rgba(231,196,90,.5);width:max-content">LIVE-BJ-XXXX</div>
        <div class="row" style="justify-content:center"><button class="btn ghost" id="copyBtn" style="display:none">Copy Code</button></div>

        <!-- Betting + Shoe -->
        <div class="zone">
          <div class="betting">
            <div class="row" style="justify-content:space-between">
              <div class="sub">Betting</div>
              <div class="row">
                <button class="btn ghost" id="undoBetBtn">Undo</button>
                <button class="btn ghost" id="clearBetBtn">Clear</button>
              </div>
            </div>
            <div class="row" style="justify-content:center">
              <div class="bet-circle pulse" id="betCircle" style="width:260px">
                <span id="betCircleTxt">Tap chips to bet</span>
              </div>
            </div>
            <div class="chips">
              <div class="chip" data-v="1"  style="--c:var(--chip-blue)"><span>1</span></div>
              <div class="chip" data-v="5"  style="--c:var(--chip-green)"><span>5</span></div>
              <div class="chip" data-v="25" style="--c:var(--chip-gold)"><span>25</span></div>
              <div class="chip" data-v="100" style="--c:var(--chip-red)"><span>100</span></div>
            </div>
            <div class="sub" style="font-size:12px">Tip: Double only right after the initial deal.</div>
          </div>

          <div class="shoe" id="shoe">
            <div class="cut"></div>
            <div class="stack" id="stack"></div>
            <div class="sub" style="position:absolute;bottom:10px;left:12px">
              Cards left: <b id="cardsLeft">‚Äî</b> ‚Ä¢ Penetration: <b id="penVal">‚Äî%</b>
            </div>
          </div>
        </div>

        <!-- FX layer -->
        <div class="fx" id="fx"></div>

        <!-- Outcome banner -->
        <div id="outcome" class="outcome" aria-live="polite">
          <div class="outcome-wrap">
            <div id="outcomeTitle" class="outcome-title">YOU WIN</div>
            <div id="outcomeSub" class="outcome-sub">Player 21 ‚Ä¢ Dealer 20</div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ===== Lock to Live realm (kept from your flow) ===== */
if (typeof window.getChoice !== 'function') { window.getChoice = () => {try{return localStorage.getItem('realm_choice')}catch(e){return null}} }
if (typeof window.setChoice !== 'function') { window.setChoice = (v) => {try{localStorage.setItem('realm_choice',v)}catch(e){}} }
const CLAIM_KEY='live_blackjack_claimed_v1', CODE='LIVE-BJ-21';
const c=getChoice(); if(c && c!=='live'){ alert('You already started Slot. Live is locked for this event.'); location.replace('index.html'); }

/* ===== DOM ===== */
const table = document.getElementById('table');
const dealerEl = document.getElementById('dealerHand');
const playerEl = document.getElementById('playerHand');
const dealerScore = document.getElementById('dealerScore');
const playerScore = document.getElementById('playerScore');
const statusEl = document.getElementById('status');
const dealBtn = document.getElementById('dealBtn');
const hitBtn = document.getElementById('hitBtn');
const standBtn = document.getElementById('standBtn');
const doubleBtn = document.getElementById('doubleBtn');
const rebetBtn = document.getElementById('rebetBtn');
const betMaxBtn = document.getElementById('betMaxBtn');
const newShoeBtn = document.getElementById('newShoeBtn');
const codeBox = document.getElementById('codeBox');
const copyBtn = document.getElementById('copyBtn');
const bankVal = document.getElementById('bankVal');
const betVal = document.getElementById('betVal');
const betCircle = document.getElementById('betCircle');
const betCircleTxt = document.getElementById('betCircleTxt');
const chips = Array.from(document.querySelectorAll('.chip'));
const undoBetBtn = document.getElementById('undoBetBtn');
const clearBetBtn = document.getElementById('clearBetBtn');
const shoeEl = document.getElementById('shoe'), stackEl = document.getElementById('stack');
const cardsLeftEl = document.getElementById('cardsLeft'), penValEl = document.getElementById('penVal');
const fx = document.getElementById('fx');
const muteBtn = document.getElementById('muteBtn');
const ambBtn = document.getElementById('ambBtn');

/* ===== Config (tweakable) ===== */
const DECKS = 6;
const MAX_CARDS_PLAYER = 5;       // set Infinity to remove cap
const FIVE_CARD_CHARLIE = false;  // true => auto-win on 5 cards <=21

/* ===== State ===== */
let shoe=[], discard=0;
let dealer=[], player=[];
let hiddenDealerCard=null, dealerHidden=true;
let inRound=false, canDouble=false;
let bank=100, bet=0, betHistory=[], lastBet=0;
let muted=false, ambience=false;
let heartbeatTimer=null;

/* ===== Audio (WebAudio) ===== */
const audio={ ctx:null, amb:null };
function ac(){ if(!audio.ctx){ audio.ctx=new (window.AudioContext||window.webkitAudioContext)(); } return audio.ctx; }
function playTone(freq=440, dur=0.07, type='sine', gain=0.06, when=0){
  if(muted) return; const ctx=ac(); const t=ctx.currentTime+when;
  const o=ctx.createOscillator(), g=ctx.createGain();
  o.type=type; o.frequency.setValueAtTime(freq,t);
  g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(gain,t+.01); g.gain.exponentialRampToValueAtTime(0.0001,t+dur);
  o.connect(g).connect(ctx.destination); o.start(t); o.stop(t+dur+.05);
}
function noise(dur=.05, gain=.05, color='bandpass', freq=1200, Q=2.5, when=0){
  if(muted) return; const ctx=ac(); const t=ctx.currentTime+when;
  const buffer=ctx.createBuffer(1, ctx.sampleRate*dur, ctx.sampleRate);
  const data=buffer.getChannelData(0); for(let i=0;i<data.length;i++) data[i]=(Math.random()*2-1);
  const src=ctx.createBufferSource(); src.buffer=buffer;
  const g=ctx.createGain(); g.gain.setValueAtTime(gain,t); g.gain.exponentialRampToValueAtTime(0.0001,t+dur);
  let f=null; if(color!=='none'){ f=ctx.createBiquadFilter(); f.type=color; f.frequency.value=freq; f.Q.value=Q; src.connect(f).connect(g).connect(ctx.destination); }
  else { src.connect(g).connect(ctx.destination); }
  src.start(t);
}
const sfx={
  click:()=>playTone(520,.05,'square',.05),
  deal:()=>{ noise(.035,.06,'bandpass',1400,2.2); playTone(220,.03,'triangle',.03,.005); },
  flip:()=>{ playTone(780,.04,'sawtooth',.045); playTone(420,.06,'triangle',.03,.02); },
  win:()=>{ playTone(660,.12,'sine',.06); playTone(880,.14,'sine',.07,.06); playTone(1320,.16,'sine',.06,.14); },
  lose:()=>{ playTone(210,.10,'triangle',.06); playTone(150,.12,'triangle',.06,.07); },
  push:()=>{ playTone(540,.07,'sine',.06); playTone(540,.07,'sine',.06,.1); },
  chip:()=>{ playTone(900,.03,'square',.05); noise(.02,.04,'bandpass',1600,1.8,.005); },
  shuffle:()=>{ for(let i=0;i<6;i++) noise(.06,.04,'bandpass',900,2,i*0.05); playTone(320,.1,'triangle',.05,.05); },
  crowdOof:()=>{ noise(.22,.06,'lowpass',380,.8); playTone(220,.12,'sine',.04,.02); },
  fanfare:()=>{ playTone(740,.12,'square',.06); playTone(988,.16,'square',.06,.08); playTone(1318,.18,'square',.06,.18); },

  // NEW: banner open/close
  bannerWhoosh: ()=>{ playTone(220,.08,'sine',.05); playTone(440,.12,'triangle',.06,.02); },
  bannerThud:   ()=>{ playTone(90,.12,'sine',.07,.02); }
};
/* ambience loop */
function toggleAmbience(on){
  if(muted) on=false;
  const ctx=ac();
  if(on && !audio.amb){
    const buffer=ctx.createBuffer(1, ctx.sampleRate*2.5, ctx.sampleRate);
    const data=buffer.getChannelData(0);
    for(let i=0;i<data.length;i++){ const r=(Math.random()*2-1); data[i]=(data[i-1]||0)*0.98 + r*0.02; }
    const src=ctx.createBufferSource(); src.loop=true; src.buffer=buffer;
    const lp=ctx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=600; lp.Q.value=0.2;
    const g=ctx.createGain(); g.gain.value=.02;
    src.connect(lp).connect(g).connect(ctx.destination);
    src.start(); audio.amb={src,g};
  }else if(!on && audio.amb){
    try{ audio.amb.src.stop(); }catch(e){}
    audio.amb=null;
  }
}

/* ===== Shoe & cards ===== */
function freshShoe(){
  const ranks=['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
  const suits=['‚ô†','‚ô•','‚ô¶','‚ô£']; let d=[];
  for(let k=0;k<DECKS;k++) suits.forEach(s=>ranks.forEach(r=>d.push({r,s})));
  for(let i=d.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [d[i],d[j]]=[d[j],d[i]]; }
  shoe=d; discard=0; renderShoe(); sfx.shuffle();
}
function draw(){ if(shoe.length===0) freshShoe(); const c=shoe.pop(); renderShoe(); return c; }
function cardsLeft(){ return shoe.length; }
function penetration(){ const total=DECKS*52; const used=total - cardsLeft(); return Math.round((used/total)*100); }
function renderShoe(){
  stackEl.innerHTML=''; const n=Math.min(10, Math.ceil(cardsLeft()/((DECKS*52)/10)));
  for(let i=0;i<n;i++){ const d=document.createElement('div'); d.style.transform=`rotate(-6deg) translateY(${-i*2}px)`; stackEl.appendChild(d); }
  cardsLeftEl.textContent=String(cardsLeft()); penValEl.textContent=String(penetration());
}
function val(h){ let sum=0, aces=0; h.forEach(c=>{ if(c.r==='A'){aces++; sum+=1} else if(['K','Q','J','10'].includes(c.r)){sum+=10}else sum+=Number(c.r) }); while(aces>0 && sum+10<=21){ sum+=10; aces--; } return sum; }
function isBlackjack(h){ return h.length===2 && val(h)===21; }

/* ===== UI helpers ===== */
function setStatus(msg, cls=''){ statusEl.className='status ' + (cls||''); statusEl.textContent=msg; }
function updateScores(){ dealerScore.textContent = dealerHidden ? '??' : val(dealer); playerScore.textContent = val(player); }
function $cardFace(c){ const el=document.createElement('div'); el.className='playing'; const f=document.createElement('div'); f.className='card3d front flip'; f.innerHTML=`<div>${c.r}${c.s}</div>`; const b=document.createElement('div'); b.className='card3d back flip'; b.innerHTML=`<div style="opacity:.8;letter-spacing:2px;color:#fff">LIVE</div>`; el.appendChild(f); el.appendChild(b); return el; }
function attachCard(container, card, faceUp=true){ const el=$cardFace(card); if(!faceUp) el.classList.add('is-back'); container.appendChild(el); return el; }

/* Flying card animation */
function flyToHand(card, toEl, faceUp=true, delay=0){
  return new Promise(res=>{
    const fxRect=fx.getBoundingClientRect(), shoeRect=shoeEl.getBoundingClientRect(), targetRect=toEl.getBoundingClientRect();
    const startX=(shoeRect.left + shoeRect.width - 48) - fxRect.left, startY=(shoeRect.top + 22) - fxRect.top;
    const endX=(targetRect.left + targetRect.width/2) - fxRect.left - 37 + (Math.random()*8-4);
    const endY=(targetRect.top + 24) - fxRect.top + (Math.random()*10-5);
    const fly=document.createElement('div'); fly.className='fly'; fly.style.transform=`translate3d(${startX}px,${startY}px,0) rotate(${Math.random()*16-8}deg)`; fx.appendChild(fly);
    setTimeout(()=>{ sfx.deal(); fly.offsetWidth; fly.style.transform=`translate3d(${endX}px,${endY}px,0) rotate(${Math.random()*10-5}deg)`; fly.addEventListener('transitionend', ()=>{ fly.remove(); const cardEl=attachCard(toEl, card, faceUp); cardEl.style.transform='translateZ(0) rotate('+(Math.random()*4-2)+'deg)'; updateScores(); res(); },{once:true}); }, delay);
  });
}

/* Outcome Banner helpers */
const outcomeEl = document.getElementById('outcome');
const outcomeTitle = document.getElementById('outcomeTitle');
const outcomeSub = document.getElementById('outcomeSub');
function showOutcome(kind, title, sub){
  outcomeEl.classList.remove('win','lose','push','show');
  outcomeEl.classList.add(kind);
  outcomeTitle.textContent = title;
  outcomeSub.textContent = sub || '';
  outcomeEl.classList.add('show');
  sfx.bannerWhoosh();
}
function hideOutcome(){
  outcomeEl.classList.remove('show');
  setTimeout(()=>{ outcomeEl.classList.remove('win','lose','push'); }, 250);
  sfx.bannerThud();
}

/* FX helpers */
function tableFlash(kind){ table.classList.remove('win','lose','push'); void table.offsetWidth; table.classList.add(kind); setTimeout(()=>table.classList.remove(kind),800); }
function sweepLight(){ table.classList.add('sweep'); setTimeout(()=>table.classList.remove('sweep'),1600); }
function cameraShake(){ table.classList.add('shake'); setTimeout(()=>table.classList.remove('shake'),420); }
function confettiBurst(){
  const rect=table.getBoundingClientRect();
  for(let i=0;i<26;i++){
    const s=document.createElement('div'); s.className='spark';
    const x = rect.width*0.5 + (Math.random()*220-110);
    const y = rect.height*0.18 + (Math.random()*40-20);
    s.style.left=x+'px'; s.style.top=y+'px';
    s.style.background=`hsl(${Math.random()*360},80%,70%)`;
    fx.appendChild(s);
    const dx=(Math.random()*2-1)*220, dy=260+Math.random()*160, rot=(Math.random()*720-360);
    s.animate([{transform:`translate(0,0) rotate(0deg)`,opacity:1},{transform:`translate(${dx}px,${dy}px) rotate(${rot}deg)`,opacity:0}],{duration:900+Math.random()*500,easing:'cubic-bezier(.2,.7,.2,1)'}).onfinish=()=>s.remove();
  }
}
function chipFly(fromEl, toEl, count=10, positive=true){
  const fr=fromEl.getBoundingClientRect(), tr=toEl.getBoundingClientRect(), fxr=fx.getBoundingClientRect();
  for(let i=0;i<count;i++){
    const chip=document.createElement('div');
    chip.style.position='absolute'; chip.style.width='14px'; chip.style.height='14px'; chip.style.borderRadius='50%';
    chip.style.background=positive?'#ffd86a':'#ff7a90'; chip.style.boxShadow='0 0 8px rgba(0,0,0,.5)';
    const sx=(fr.left+fr.width/2)-fxr.left + (Math.random()*30-15), sy=(fr.top+fr.height/2)-fxr.top + (Math.random()*30-15);
    const ex=(tr.left+tr.width/2)-fxr.left + (Math.random()*20-10), ey=(tr.top+tr.height/2)-fxr.top + (Math.random()*20-10);
    chip.style.transform=`translate(${sx}px,${sy}px)`; fx.appendChild(chip);
    chip.animate([{transform:`translate(${sx}px,${sy}px) scale(.9)`},{transform:`translate(${ex}px,${ey}px) scale(1)`}],{duration:420+Math.random()*220,easing:'cubic-bezier(.22,.8,.24,1)'}).onfinish=()=>chip.remove();
  }
}

/* Heartbeat cue (16‚Äì20) */
function startHeartbeat(){ stopHeartbeat(); const beat=()=>{ if(muted) return; playTone(120,.05,'sine',.035); setTimeout(()=>playTone(90,.06,'sine',.03),110); }; heartbeatTimer=setInterval(beat,750); }
function stopHeartbeat(){ if(heartbeatTimer){ clearInterval(heartbeatTimer); heartbeatTimer=null; } }

/* Betting */
function renderBankBet(){ bankVal.textContent=bank.toString(); betVal.textContent=bet.toString(); betCircleTxt.textContent=bet>0?`Bet: ${bet}`:'Tap chips to bet'; if(bet>0) betCircle.classList.remove('pulse'); else betCircle.classList.add('pulse'); }
chips.forEach(ch=>ch.addEventListener('click',()=>{ if(inRound) return; const v=Number(ch.dataset.v); if(bank>=v){ bank-=v; bet+=v; betHistory.push(v); renderBankBet(); sfx.chip(); } else setStatus('Not enough bank for that chip','lose'); }));
undoBetBtn.addEventListener('click',()=>{ if(inRound) return; const v=betHistory.pop(); if(v){ bet-=v; bank+=v; sfx.click(); renderBankBet(); }});
clearBetBtn.addEventListener('click',()=>{ if(inRound) return; while(betHistory.length){ const v=betHistory.pop(); bet-=v; bank+=v; } sfx.click(); renderBankBet(); });
rebetBtn.addEventListener('click',()=>{ if(inRound) return; if(lastBet>0 && bank>=lastBet){ bank-=lastBet; bet+=lastBet; betHistory.push(lastBet); renderBankBet(); sfx.chip(); }});
betMaxBtn.addEventListener('click',()=>{ if(inRound) return; if(bank<=0) return; const v=bank; bank=0; bet+=v; betHistory.push(v); renderBankBet(); sfx.chip(); });

/* Flow */
function resetHands(){
  dealer=[]; player=[]; dealerHidden=true; hiddenDealerCard=null;
  dealerEl.querySelectorAll('.playing').forEach(n=>n.remove());
  playerEl.querySelectorAll('.playing').forEach(n=>n.remove());
  updateScores();
}
function flipDealerHole(){
  if(!hiddenDealerCard) return;
  const first=dealerEl.querySelector('.playing');
  if(first){ sfx.flip(); first.classList.toggle('is-back'); }
  dealerHidden=false; updateScores();
}
function dealerPeek(){
  const first=dealerEl.querySelector('.playing');
  if(first){ first.style.animation='peekUp .4s ease'; setTimeout(()=>first.style.animation='',420); }
}

async function initialDeal(){
  stopHeartbeat(); resetHands();
  if(bet<=0){ setStatus('Place a bet first'); return false; }
  setChoice('live'); inRound=true; canDouble=false;
  dealBtn.disabled=true; hitBtn.disabled=false; standBtn.disabled=false; doubleBtn.disabled=true;

  const p1=draw(); player.push(p1); await flyToHand(p1, playerEl, true, 40);
  const d1=draw(); dealer.push(d1); hiddenDealerCard=d1; await flyToHand(d1, dealerEl, false, 40); dealerPeek();
  const p2=draw(); player.push(p2); await flyToHand(p2, playerEl, true, 40);
  const d2=draw(); dealer.push(d2); await flyToHand(d2, dealerEl, true, 40);

  canDouble=true; doubleBtn.disabled=false; lastBet=bet;
  updateScores();

  if(isBlackjack(player)){
    flipDealerHole(); await new Promise(r=>setTimeout(r,300));
    if(isBlackjack(dealer)) settle('push'); else settle('win-bj');
    return false;
  }
  setStatus('Hit, Stand, or Double');
  const pv=val(player); if(pv>=16 && pv<=20) startHeartbeat();
  return true;
}
function dealerPlayNeeded(){ return val(dealer) < 17; }
async function dealerTurn(){
  flipDealerHole();
  await new Promise(r=>setTimeout(r,220));
  while(dealerPlayNeeded()){
    const c=draw(); dealer.push(c); await flyToHand(c, dealerEl, true, 50); await new Promise(r=>setTimeout(r,140));
  }
}
function payout(outcome){
  if(outcome==='win') bank += bet*2;
  else if(outcome==='win-bj') bank += Math.floor(bet*2.5);
  else if(outcome==='push') bank += bet;
  renderBankBet();
}
function finalizeVoucher(){
  codeBox.style.display='inline-block'; codeBox.textContent=CODE; copyBtn.style.display='inline-block';
  try{ localStorage.setItem(CLAIM_KEY, JSON.stringify({code:CODE, ts:Date.now()})); }catch(e){}
}

/* Settle with banner + sounds */
function settle(kind){
  stopHeartbeat();
  inRound=false; hitBtn.disabled=true; standBtn.disabled=true; doubleBtn.disabled=true; dealBtn.disabled=false;

  const p = val(player), d = val(dealer);
  const sub = `Player ${p} ‚Ä¢ Dealer ${d}`;

  // Clear previous accent class and banner state
  table.classList.remove('win','lose','push');

  const bankEl = bankVal.closest('.pill');

  if(kind==='win'){
    setStatus('You win!','win');
    showOutcome('win', 'YOU WIN', sub);
    sfx.win(); sfx.fanfare(); confettiBurst(); tableFlash('win');
    chipFly(betCircle, bankEl, 14, true); payout('win'); finalizeVoucher();
  }else if(kind==='win-bj'){
    setStatus('Blackjack! 3:2','win');
    showOutcome('win', 'BLACKJACK!', sub);
    sfx.win(); sfx.fanfare(); confettiBurst(); tableFlash('win');
    chipFly(betCircle, bankEl, 16, true); payout('win-bj'); finalizeVoucher();
  }else if(kind==='lose'){
    setStatus('Dealer wins','lose');
    showOutcome('lose', 'DEALER WINS', sub);
    sfx.lose(); sfx.crowdOof(); tableFlash('lose'); cameraShake();
    chipFly(betCircle, shoeEl, 12, false);
  }else{
    setStatus('Push','push');
    showOutcome('push', 'PUSH', sub);
    sfx.push(); tableFlash('push'); payout('push');
  }

  // Auto-hide banner after a moment (remove if you want it sticky)
  setTimeout(hideOutcome, 1700);
}

/* Bust check */
function bustCheck(){
  const v=val(player);
  if(v>21){ setStatus('Bust! Dealer wins','lose'); sfx.lose(); settle('lose'); return true; }
  return false;
}

/* Events */
dealBtn.addEventListener('click', async ()=>{ if(inRound) return; if(bet<=0){ setStatus('Place a bet first'); return; } sfx.click(); await initialDeal(); });
hitBtn.addEventListener('click', async ()=>{
  if(!inRound) return; sfx.click();
  if (player.length >= MAX_CARDS_PLAYER) { setStatus(`Max ${MAX_CARDS_PLAYER} cards ‚Äî Stand`, ''); hitBtn.disabled = true; return; }
  const c=draw(); player.push(c); await flyToHand(c, playerEl, true, 30);
  canDouble=false; doubleBtn.disabled=true;

  if (FIVE_CARD_CHARLIE && player.length >= 5 && val(player) <= 21) { setStatus('5-Card Charlie! You win','win'); settle('win'); return; }

  if(!bustCheck()){
    setStatus('Hit, Stand, or Double');
    const pv=val(player); if(pv>=16 && pv<=20) startHeartbeat(); else stopHeartbeat();
  }
});
standBtn.addEventListener('click', async ()=>{ if(!inRound) return; sfx.click(); stopHeartbeat(); await dealerTurn(); const p=val(player), d=val(dealer); if(d>21 || p>d) settle('win'); else if(p===d) settle('push'); else settle('lose'); });
doubleBtn.addEventListener('click', async ()=>{
  if(!inRound || !canDouble) return;
  if(bank < bet){ setStatus('Not enough bank to Double','lose'); return; }
  sfx.click(); bank -= bet; bet += bet; renderBankBet();
  const c=draw(); player.push(c); await flyToHand(c, playerEl, true, 30);
  if(bustCheck()) return;
  await dealerTurn(); const p=val(player), d=val(dealer);
  if(d>21 || p>d) settle('win'); else if(p===d) settle('push'); else settle('lose');
});
newShoeBtn.addEventListener('click', ()=>{ freshShoe(); setStatus('New shoe shuffled'); });
copyBtn.addEventListener('click', ()=>{ const t=codeBox.textContent.trim(); if(!t)return; navigator.clipboard.writeText(t).then(()=>{ copyBtn.textContent='Copied!'; setTimeout(()=>copyBtn.textContent='Copy Code',1200); });});
muteBtn.addEventListener('click', ()=>{ muted=!muted; muteBtn.textContent = muted? 'üîá SFX' : 'üîä SFX'; sfx.click(); if(muted) toggleAmbience(false); });
ambBtn.addEventListener('click', ()=>{ ambience=!ambience; ambBtn.textContent = ambience? 'üéµ Ambience' : 'üéß Ambience'; toggleAmbience(ambience); sfx.click(); });

/* Prior claim */
try{ const prior=localStorage.getItem(CLAIM_KEY); if(prior){ codeBox.style.display='inline-block'; codeBox.textContent=JSON.parse(prior).code||CODE; copyBtn.style.display='inline-block'; } }catch(e){}

/* Init */
freshShoe(); renderBankBet(); updateScores(); setStatus('Place a bet, then Deal');
</script>
</body>
</html>
