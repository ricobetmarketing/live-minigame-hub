<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Live ‚Äî Baccarat Auto Flip (Crowd ‚Ä¢ SFX ‚Ä¢ Bead Road)</title>
<style>
  :root{
    --ink:#eaf2ff; --mut:#9fb0d9; --g1:#71e1ff; --g2:#25c3ff;
    --haloA:#71e1ff66; --haloB:#c06bff55; --haloC:#ffd86a44;
    --player:#2bd2ff; --banker:#ff6aa3; --tie:#ffe26a;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    background:radial-gradient(1400px 900px at 70% -10%, #18244d 0%, #0a0f1e 55%, #05070d 100%);
    font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
    display:flex; align-items:center; justify-content:center; padding:18px;
  }
  a.back{
    position:fixed; left:12px; top:12px; z-index:10; text-decoration:none;
    background:rgba(0,0,0,.5); padding:8px 12px; border-radius:10px; color:#fff; font-weight:700
  }
  .wrap{ width:min(1060px,96vw) }
  .card{
    position:relative; border-radius:22px; padding:18px; overflow:visible;
    background:linear-gradient(180deg,#1b2a56,#0f1832);
    outline:1px solid rgba(255,255,255,.08);
    box-shadow:0 16px 60px rgba(0,0,0,.55);
  }
  .card::before{
    content:""; position:absolute; inset:-10% -8% -16% -8%; z-index:-1;
    background:
      radial-gradient(closest-side at 50% 10%, var(--haloA), transparent 70%),
      radial-gradient(closest-side at 65% 60%, var(--haloB), transparent 72%),
      radial-gradient(closest-side at 35% 90%, var(--haloC), transparent 70%);
    filter: blur(24px);
  }
  .card::after{
    content:""; position:absolute; inset:-8% -6% -14% -6%; z-index:-1;
    background: radial-gradient(120% 100% at var(--sx,40%) var(--sy,10%),
                rgba(255,255,255,.12), rgba(255,255,255,0) 60%);
    filter: blur(10px); mix-blend-mode:screen; animation: sweep 8s ease-in-out infinite;
  }
  @keyframes sweep{ 0%{--sx:35%;--sy:12%;opacity:.45}50%{--sx:65%;--sy:18%;opacity:.9}100%{--sx:35%;--sy:12%;opacity:.45} }

  h1{margin:0 0 8px; font-size:22px; font-weight:900; text-transform:uppercase}
  p.sub{margin:0 6px 16px; color:var(--mut)}

  /* Top info row */
  .topbar{
    display:grid; grid-template-columns:1fr auto auto; gap:10px; align-items:center; margin-bottom:10px; padding:0 2px;
  }
  .shoe{
    display:flex; align-items:center; gap:10px;
    background:rgba(0,0,0,.28); border:1px solid rgba(255,255,255,.08);
    border-radius:12px; padding:8px 10px; min-width:260px;
  }
  .bar{ position:relative; flex:1 1 auto; height:8px; border-radius:999px; background:#16213f; overflow:hidden }
  .bar>i{position:absolute; left:0; top:0; bottom:0; width:0%; background:linear-gradient(90deg,#65f0ff,#ff62ff); transition:width .25s ease}
  .cutTag{
    font-size:11px; padding:3px 8px; border-radius:999px; font-weight:900;
    background:#28121f; color:#ffd2de; border:1px solid rgba(255,200,220,.25);
    box-shadow:0 0 12px rgba(255,120,180,.2) inset; justify-self:start;
  }
  .sound{ justify-self:end }
  .toggle{border:0;border-radius:12px;padding:8px 12px;font-weight:900;cursor:pointer;background:#2b2b2b;color:#fff}

  .felt{
    position:relative; border-radius:18px; padding:14px; perspective:1400px;
    background:radial-gradient(closest-side,#13325f,#0e1f43);
    outline:1px solid rgba(255,255,255,.08);
    box-shadow:inset 0 0 60px rgba(0,0,0,.6), 0 0 60px rgba(113,225,255,.18), 0 0 80px rgba(192,107,255,.16);
  }
  #fx{ position:absolute; inset:0; pointer-events:none; }

  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:center}
  .btn{
    border:0; border-radius:12px; padding:10px 14px; font-weight:900; cursor:pointer;
    background:linear-gradient(to right,var(--g1),var(--g2)); color:#061018;
    box-shadow:0 0 18px rgba(113,225,255,.5), inset 0 -3px 0 rgba(0,0,0,.35)
  }
  .ghost{ background:#2b2b2b; color:#fff }
  .btn:disabled{ opacity:.6; pointer-events:none }

  .crowd{
    display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-bottom:8px;
  }
  .meter{
    background:rgba(0,0,0,.28); border:1px solid rgba(255,255,255,.08);
    border-radius:12px; padding:8px 10px;
  }
  .meter h4{margin:0 0 6px; font-size:12px; color:#cfd9ff}
  .track{position:relative; height:8px; border-radius:999px; background:#16213f; overflow:hidden}
  .fill{position:absolute; inset:0; width:0%; transition:width .5s ease}
  .player .fill{background:linear-gradient(90deg,var(--player),#79f0ff)}
  .banker .fill{background:linear-gradient(90deg,var(--banker),#ff98be)}
  .tie .fill{background:linear-gradient(90deg,var(--tie),#fff1a6)}
  .pct{font-size:12px; text-align:right; margin-top:4px; color:#9fb0d9}

  .zone{display:grid; gap:10px; grid-template-columns:1fr 1fr; align-items:center}
  .side{ border-radius:16px; background:rgba(0,0,0,.25); padding:12px; outline:1px solid rgba(255,255,255,.08); transform-style:preserve-3d; }
  .side h3{margin:0 0 6px; font-size:14px; display:flex; justify-content:space-between; align-items:center}
  .hand{display:flex; gap:12px; justify-content:center; min-height:126px; position:relative; overflow:visible}

  .playing-card{
    --blur:4px; --veil:.78;
    position:relative; width:90px; height:126px; border-radius:14px;
    background:radial-gradient(240px 160px at 50% -20%,#fff,#e9eefc 40%,#c8d4f3 100%);
    outline:2px solid #e5ecff; box-shadow:0 16px 28px rgba(0,0,0,.4);
    display:grid; place-items:center; font-weight:900; color:#1a2050; overflow:hidden;
    transform: translateZ(0) rotateX(6deg);
    transform-style:preserve-3d; backface-visibility:hidden; will-change:transform;
  }
  .deal-in{ opacity:0; transform:translateY(-30px) rotateX(12deg) scale(.96); animation: deal .42s cubic-bezier(.2,.8,.2,1) forwards; }
  @keyframes deal{ to{ opacity:1; transform:translateY(0) rotateX(6deg) scale(1) } }

  /* Auto flip (ensure card remains visible) */
  .flip{ animation: yflip .48s ease both; }
  @keyframes yflip{
    0%  { transform: rotateY(90deg) rotateX(6deg) }
    55% { transform: rotateY(-10deg) rotateX(6deg) }
    100%{ transform: rotateY(0deg) rotateX(6deg) }
  }
  .face{ filter:blur(var(--blur)); transform:translateZ(2px); backface-visibility:hidden; will-change:filter,transform; }
  .playing-card.show .face{ filter:none; transition:filter .2s ease }
  .cover{
    position:absolute; inset:0; pointer-events:none;
    background: linear-gradient(180deg, rgba(10,16,30,var(--veil)), rgba(10,16,30,calc(var(--veil) - .2)));
    transition: opacity .2s ease, background .2s ease; backface-visibility:hidden;
  }
  .playing-card.show .cover{ opacity:0 }

  /* Chips */
  .chip{
    position:absolute; top:-8px; left:50%; transform:translateX(-50%);
    width:26px; height:26px; border-radius:50%; font-size:12px; font-weight:900; display:grid; place-items:center; color:#091020;
    background:radial-gradient(circle at 35% 35%, #fff, #f7f7f7 40%, #ddd 70%, #bbb 100%);
    box-shadow:0 8px 24px rgba(0,0,0,.45);
    animation: toss .6s ease forwards;
  }
  .chip.p{ border:3px solid var(--player) } .chip.b{ border:3px solid var(--banker) } .chip.t{ border:3px solid var(--tie) }
  @keyframes toss{
    0%{ transform:translate(-50%,-60px) scale(.8); opacity:0 }
    60%{ transform:translate(-50%,-10px) scale(1.02); opacity:1 }
    100%{ transform:translate(-50%,0) scale(1); }
  }

  .score{text-align:center; color:#ffd86a; font-weight:900; text-shadow:0 0 10px rgba(255,216,106,.6); margin-top:6px}
  .status{text-align:center; margin-top:10px; color:#9fb0d9}

  .code{
    display:none; margin-top:10px; text-align:center;
    font-family:ui-monospace,SFMono-Regular,Menlo,monospace; letter-spacing:.5px;
    padding:10px 12px; border-radius:12px; background:#0a0d1a; outline:1px dashed rgba(160,220,255,.35)
  }
  .copy{
    display:none; margin-top:8px; border:0; border-radius:10px; padding:8px 10px; font-weight:900;
    background:#2b2b2b; color:#fff
  }

  .announcer{
    position:absolute; left:50%; top:-10px; transform:translate(-50%,-100%);
    background:rgba(0,0,0,.55); border:1px solid rgba(255,255,255,.12);
    padding:10px 14px; border-radius:12px; font-weight:900; letter-spacing:.3px;
    box-shadow:0 10px 40px rgba(0,0,0,.45); opacity:0; pointer-events:none;
  }
  .announcer.show{ animation: toast 2.2s ease forwards }
  @keyframes toast{
    0%{opacity:0; transform:translate(-50%,-130%)}
    10%{opacity:1; transform:translate(-50%,-100%)}
    80%{opacity:1}
    100%{opacity:0; transform:translate(-50%,-130%)}
  }

  /* Bead road */
  .beads{
    margin-top:10px; display:flex; gap:6px; flex-wrap:wrap; justify-content:center
  }
  .bead{ width:16px; height:16px; border-radius:50%; box-shadow:0 0 10px rgba(0,0,0,.4) inset }
  .bead.p{ background:var(--player) } .bead.b{ background:var(--banker) } .bead.t{ background:var(--tie) }
</style>
</head>
<body>
  <a class="back" href="index.html">‚Üê Back</a>
  <div class="wrap">
    <div class="card">
      <h1>Baccarat ‚Äî Auto Flip</h1>
      <p class="sub">Bet ‚Üí Deal ‚Üí Cards flip automatically in order (P1 ‚Üí B1 ‚Üí P2 ‚Üí B2 ‚Üí P3? ‚Üí B3?). True third-card rules, burn & cut, announcer, SFX, crowd.</p>

      <div class="topbar">
        <div class="shoe">
          <div style="font-weight:800">Shoe</div>
          <div class="bar"><i id="shoeFill"></i></div>
          <div id="shoeLeft" style="font-size:12px; min-width:70px; text-align:right">‚Äî</div>
        </div>
        <div class="cutTag" id="cutTag" style="display:none">Cut reached ‚Äî last hand</div>
        <div class="sound"><button id="soundBtn" class="toggle">üîä Sound: On</button></div>
      </div>

      <div class="felt">
        <div class="announcer" id="announcer">Announcement</div>
        <canvas id="fx"></canvas>

        <!-- Crowd meters -->
        <div class="crowd" id="crowdMeters">
          <div class="meter player">
            <h4>Table Bets ‚Äî Player</h4>
            <div class="track"><div class="fill" id="mP"></div></div>
            <div class="pct" id="pP">0%</div>
          </div>
          <div class="meter banker">
            <h4>Table Bets ‚Äî Banker</h4>
            <div class="track"><div class="fill" id="mB"></div></div>
            <div class="pct" id="pB">0%</div>
          </div>
          <div class="meter tie">
            <h4>Table Bets ‚Äî Tie</h4>
            <div class="track"><div class="fill" id="mT"></div></div>
            <div class="pct" id="pT">0%</div>
          </div>
        </div>

        <div class="row" style="margin-bottom:10px">
          <button class="btn" id="betPlayer">Bet Player</button>
          <button class="btn ghost" id="betBanker">Bet Banker</button>
          <button class="btn" id="dealBtn" disabled>Deal</button>
          <button class="btn ghost" id="reshuffleBtn" style="display:none">Reshuffle</button>
        </div>

        <div class="zone">
          <div class="side" id="playerSide">
            <h3>üÇ° Player <span id="pScore">‚Äî</span></h3>
            <div class="hand" id="pHand"></div>
          </div>
          <div class="side" id="bankerSide">
            <h3>üÇ± Banker <span id="bScore">‚Äî</span></h3>
            <div class="hand" id="bHand"></div>
          </div>
        </div>

        <div class="score" id="result">Place your bet</div>
        <div class="status" id="hint">Cards reveal automatically. Enjoy the show ‚ú®</div>

        <div class="beads" id="beads"></div>

        <div class="code" id="codeBox">LIVE-BAC-XXXX</div>
        <button class="copy" id="copyBtn">Copy Code</button>
      </div>
    </div>
  </div>

<!-- SFX -->
<audio id="sDeal"    src="https://cdn.jsdelivr.net/gh/naptha/tinyfiles@main/slot/lever.mp3" preload="auto"></audio>
<audio id="sFlip"    src="https://cdn.jsdelivr.net/gh/naptha/tinyfiles@main/slot/stop.mp3"  preload="auto"></audio>
<audio id="sWin"     src="https://cdn.jsdelivr.net/gh/naptha/tinyfiles@main/slot/win.mp3"   preload="auto"></audio>
<audio id="sShuffle" src="https://cdn.jsdelivr.net/gh/naptha/tinyfiles@main/slot/win.mp3"   preload="auto"></audio>

<script>
/* ------- Fallback if assets/common.js is missing ------- */
if (typeof window.getChoice !== 'function') {
  window.getChoice = function(){ try { return localStorage.getItem('realm_choice'); } catch(e){ return null; } };
}
if (typeof window.setChoice !== 'function') {
  window.setChoice = function(v){ try { localStorage.setItem('realm_choice', v); } catch(e){} };
}

/* ------- Config ------- */
const CLAIM_KEY='live_bac_auto_claimed_v2';
const CODE_WIN='LIVE-BAC-WIN', CODE_LOSE='TRY-AGAIN-NEXT-TIME';
const DECKS = 6;           // 6-deck shoe
const CUT_BACK_MIN = 14;   // cut card ~14‚Äì26 from back
const CUT_BACK_RNG = 12;

const REVEAL_DELAY = 700;  // ms between flips (first four)
const REVEAL_DELAY_3 = 800;// ms for third-card flips
const START_DELAY = 550;   // ms before first flip after dealing

/* ------- Realm lock ------- */
const c=getChoice(); if(c && c!=='live'){ alert('You already started Slot. Live is locked for this event.'); location.replace('index.html'); }

/* ------- Audio control (unlocked on first click) ------- */
let soundOn = true, audioUnlocked = false;
const soundBtn = document.getElementById('soundBtn');
soundBtn.addEventListener('click',()=>{
  soundOn = !soundOn;
  soundBtn.textContent = soundOn ? 'üîä Sound: On' : 'üîà Sound: Off';
});
function playS(s){ if(soundOn){ try{ s.currentTime=0; s.play().catch(()=>{});}catch(e){} } }
function unlockAudioOnce(){
  [sDeal,sFlip,sWin,sShuffle].forEach(a=>{
    try{ a.muted=true; a.play().then(()=>{ a.pause(); a.currentTime=0; a.muted=false; }); }catch(e){}
  });
  audioUnlocked = true;
  document.removeEventListener('pointerdown', unlockAudioOnce);
}
document.addEventListener('pointerdown', unlockAudioOnce, { once:true });

/* ------- Data helpers ------- */
const ranks=['A','2','3','4','5','6','7','8','9','10','J','Q','K'], suits=['‚ô†','‚ô•','‚ô¶','‚ô£'];
const rnd = a => a[(Math.random()*a.length)|0];
const val = r => (r==='A'?1: (['10','J','Q','K'].includes(r)?0:Number(r)));

/* ------- State + DOM ------- */
let bet=null, dealt=false;
let player=[], banker=[];
let order=[], step=0, thirdProcessed=false;

let shoe=[], shoeSize=0, cutLine=0, cutReached=false, shoeNeedsShuffle=false;
const history=[];

const betPlayer = document.getElementById('betPlayer');
const betBanker = document.getElementById('betBanker');
const dealBtn   = document.getElementById('dealBtn');
const reshuffleBtn = document.getElementById('reshuffleBtn');

const pHand     = document.getElementById('pHand');
const bHand     = document.getElementById('bHand');
const pScoreEl  = document.getElementById('pScore');
const bScoreEl  = document.getElementById('bScore');
const resultEl  = document.getElementById('result');
const hintEl    = document.getElementById('hint');
const codeBox   = document.getElementById('codeBox');
const copyBtn   = document.getElementById('copyBtn');

const shoeFill  = document.getElementById('shoeFill');
const shoeLeft  = document.getElementById('shoeLeft');
const cutTag    = document.getElementById('cutTag');
const announcer = document.getElementById('announcer');

const mP=document.getElementById('mP'), mB=document.getElementById('mB'), mT=document.getElementById('mT');
const pP=document.getElementById('pP'), pB=document.getElementById('pB'), pT=document.getElementById('pT');
const beads=document.getElementById('beads');

const sDeal = document.getElementById('sDeal');
const sFlip = document.getElementById('sFlip');
const sWin  = document.getElementById('sWin');
const sShuffle = document.getElementById('sShuffle');

/* Confetti FX */
const fx = document.getElementById('fx'); const ctx = fx.getContext('2d');
function resizeFX(){ fx.width = fx.parentElement.clientWidth; fx.height = fx.parentElement.clientHeight; }
addEventListener('resize', resizeFX); addEventListener('orientationchange', ()=>setTimeout(resizeFX,200)); resizeFX();
function confetti(){
  const p=[]; for(let i=0;i<220;i++) p.push({x:fx.width/2,y:60+Math.random()*40,vx:(Math.random()-0.5)*6,vy:(Math.random()-0.5)*5,life:160+Math.random()*60,r:2+Math.random()*3,h:Math.random()*360});
  (function loop(){
    ctx.clearRect(0,0,fx.width,fx.height);
    p.forEach(o=>{ o.x+=o.vx; o.y+=o.vy; o.vy+=0.06; o.life--; ctx.globalAlpha=Math.max(0,o.life/220); ctx.fillStyle=`hsl(${o.h},100%,60%)`; ctx.fillRect(o.x,o.y,o.r,o.r);});
    ctx.globalAlpha=1;
    if(p.some(o=>o.life>0)) requestAnimationFrame(loop);
  })();
}

/* ------- Announcer ------- */
function announce(msg){
  announcer.textContent = msg;
  announcer.classList.remove('show');
  void announcer.offsetWidth; // reflow
  announcer.classList.add('show');
}

/* ------- Shoe (6-deck) ------- */
function makeShoe(decks=DECKS){
  const d=[];
  for(let k=0;k<decks;k++){
    for(const s of suits){
      for(const r of ranks){ d.push({r,s}); }
    }
  }
  for(let i=d.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [d[i],d[j]]=[d[j],d[i]]; }
  return d;
}

function initShoe(){
  shoe = makeShoe(DECKS);
  shoeSize = shoe.length;
  cutLine = Math.floor(CUT_BACK_MIN + Math.random()*CUT_BACK_RNG);
  cutReached = false; shoeNeedsShuffle = false;
  updateShoeBar();
  // Burn
  const burnFirst = shoe.pop();
  const burnVal = Math.max(1, val(burnFirst.r) || 10);
  for(let i=0;i<burnVal;i++) shoe.pop();
  announce(`Burn card: ${burnFirst.r}${burnFirst.s} ‚Äî burn ${burnVal} more`);
  playS(sShuffle);
  updateShoeBar();
  reshuffleBtn.style.display='none';
}

function drawFromShoe(){
  if(shoe.length<=0){ initShoe(); }
  const card = shoe.pop();
  updateShoeBar();
  if(!cutReached && shoe.length<=cutLine){
    cutReached = true; cutTag.style.display='inline-block';
    announce('Cut card reached ‚Äî last hand of shoe');
  }
  return card;
}

function updateShoeBar(){
  const left = shoe.length;
  shoeLeft.textContent = `${left} left`;
  const pct = Math.max(0, Math.min(100, Math.round((left/shoeSize)*100)));
  shoeFill.style.width = pct + '%';
  if(left<=cutLine){ shoeFill.style.filter='drop-shadow(0 0 6px rgba(255,120,160,.7))'; }
  else shoeFill.style.filter='none';
}

/* ------- Scores & UI ------- */
function score(hand){ return hand.reduce((t,c)=>t+val(c.r),0)%10; }
function twoScore(hand){ return (val(hand[0].r)+val(hand[1].r))%10; }
function updateScores(){
  const ps = player.some(c=>c.shown) ? score(player) : '??';
  const bs = banker.some(c=>c.shown) ? score(banker) : '??';
  pScoreEl.textContent = ps; bScoreEl.textContent = bs;
}

/* ------- Build card element ------- */
function makeCardEl(cardObj){
  const el=document.createElement('div');
  el.className='playing-card deal-in';
  el.innerHTML=`
    <div class="face">${cardObj.r}${cardObj.s}</div>
    <div class="cover"></div>
  `;
  el.style.animationDelay = (cardObj.delay || 0)+'ms';
  return el;
}

/* ------- Flip animation (auto) ------- */
function flipCard(card){
  if(card.shown) return;
  card.shown = true;
  card.el.classList.add('flip');
  // ensure visible (no disappearing)
  card.el.style.setProperty('--blur','0px');
  card.el.style.setProperty('--veil','0.0');
  playS(sFlip);
  setTimeout(()=>{ card.el.classList.add('show'); updateScores(); }, 240);
}

/* ------- Crowd (table bets) ------- */
function crowdBets(){
  // random distribution (bias banker slightly like real casinos)
  let pb = Math.random()*0.48 + 0.26; // banker 26‚Äì74%
  let pp = Math.random()*(1-pb-0.02); // player gets the rest minus a bit
  let pt = Math.max(0.02, 1 - pb - pp); // tie at least 2%
  // normalize and to %
  const sum = pb+pp+pt; pb/=sum; pp/=sum; pt/=sum;
  const P = Math.round(pp*100), B = Math.round(pb*100), T = Math.max(0,100-P-B);
  mP.style.width = P+'%'; mB.style.width = B+'%'; mT.style.width = T+'%';
  pP.textContent = P+'%'; pB.textContent = B+'%'; pT.textContent = T+'%';
  return {P,B,T};
}
function tossChips(side, count=6){
  const area = side==='p'? pHand : side==='b'? bHand : null;
  if(!area) return;
  for(let i=0;i<count;i++){
    const ch=document.createElement('div');
    ch.className='chip ' + (side==='p'?'p':'b');
    ch.textContent = ['1','5','10','25'][Math.floor(Math.random()*4)];
    ch.style.left = (30 + Math.random()*40) + '%';
    ch.style.top  = (-10 - Math.random()*30) + 'px';
    area.appendChild(ch);
    setTimeout(()=> ch.remove(), 1200);
  }
}

/* ------- Bet / Deal ------- */
function choose(side){
  if(bet) return;
  setChoice('live');
  bet=side; dealBtn.disabled=false;
  resultEl.textContent='Bet on ' + (side==='player'?'Player':'Banker') + ' ‚Äî tap Deal';
  betPlayer.disabled=true; betBanker.disabled=true;
}
betPlayer.addEventListener('click', ()=>choose('player'));
betBanker.addEventListener('click', ()=>choose('banker'));

function ensureShoeReady(){
  if(!shoe.length || shoeNeedsShuffle){ initShoe(); }
  if(shoe.length<6){ initShoe(); }
}

function deal(){
  if(dealt) return; dealt=true; thirdProcessed=false; order=[]; step=0;
  ensureShoeReady();
  // crowd + chips
  const cm = crowdBets();
  tossChips('p', Math.round(cm.P/12)+2);
  tossChips('b', Math.round(cm.B/12)+2);

  playS(sDeal);
  // initial two each from shoe
  const cP1 = drawFromShoe(), cB1 = drawFromShoe(), cP2 = drawFromShoe(), cB2 = drawFromShoe();
  player = [ {r:cP1.r,s:cP1.s,shown:false,side:'p',idx:0,delay:80},
             {r:cP2.r,s:cP2.s,shown:false,side:'p',idx:1,delay:360} ];
  banker = [ {r:cB1.r,s:cB1.s,shown:false,side:'b',idx:0,delay:220},
             {r:cB2.r,s:cB2.s,shown:false,side:'b',idx:1,delay:500} ];

  pHand.innerHTML=''; bHand.innerHTML='';
  player.forEach(c=>{ c.el = makeCardEl(c); pHand.appendChild(c.el); });
  banker.forEach(c=>{ c.el = makeCardEl(c); bHand.appendChild(c.el); });
  order = [ player[0], banker[0], player[1], banker[1] ];
  updateScores();
  resultEl.textContent='Dealt ‚Äî revealing‚Ä¶';
  setTimeout(runAutoReveals, START_DELAY);
}
dealBtn.addEventListener('click', deal);

reshuffleBtn.addEventListener('click', ()=>{ initShoe(); announce('New shoe shuffled'); });

/* ------- Auto reveal engine ------- */
function runAutoReveals(){
  const revealNext = ()=>{
    if(step < order.length){
      flipCard(order[step++]);
      setTimeout(revealNext, REVEAL_DELAY);
    }else{
      if(!thirdProcessed){
        thirdProcessed = true;
        const added = processThirdCards();
        if(added){
          setTimeout(()=>{
            const revealThirds = ()=>{
              if(step < order.length){
                flipCard(order[step++]);
                setTimeout(revealThirds, REVEAL_DELAY_3);
              }else{
                finishRound();
              }
            };
            revealThirds();
          }, 380);
          return;
        }
      }
      finishRound();
    }
  };
  revealNext();
}

/* ------- Third-card decision (true rules) + announcements ------- */
function processThirdCards(){
  const pTwo = twoScore(player);
  const bTwo = twoScore(banker);

  if (pTwo>=8 || bTwo>=8){
    announce(`Natural ${Math.max(pTwo,bTwo)} ‚Äî no draws`);
    return false;
  }

  let playerDraws = (pTwo<=5);
  let bankerDraws = false;
  let p3=null, b3=null;

  if (!playerDraws){
    bankerDraws = (bTwo<=5);
    announce(`Player stands ${pTwo}${bankerDraws? ' ‚Äî Banker draws' : ' ‚Äî Banker stands'}`);
    if (bankerDraws){
      const c = drawFromShoe();
      b3 = {r:c.r, s:c.s, shown:false, side:'b', idx:2, delay:160};
    }
  } else {
    const cp = drawFromShoe();
    p3 = {r:cp.r, s:cp.s, shown:false, side:'p', idx:2, delay:120};
    const pv = val(cp.r);
    if (bTwo<=2) bankerDraws = true;
    else if (bTwo===3) bankerDraws = (pv!==8);
    else if (bTwo===4) bankerDraws = (pv>=2 && pv<=7);
    else if (bTwo===5) bankerDraws = (pv>=4 && pv<=7);
    else if (bTwo===6) bankerDraws = (pv===6 || pv===7);
    else bankerDraws = false;

    announce(`Player draws ${cp.r}${cp.s}${bankerDraws? ' ‚Äî Banker draws' : ' ‚Äî Banker stands'}`);

    if (bankerDraws){
      const cb = drawFromShoe();
      b3 = {r:cb.r, s:cb.s, shown:false, side:'b', idx:2, delay:220};
    }
  }

  let added=false;
  if (p3){ p3.el = makeCardEl(p3); pHand.appendChild(p3.el); order.push(p3); added=true; }
  if (b3){ b3.el = makeCardEl(b3); bHand.appendChild(b3.el); order.push(b3); added=true; }

  if(added) playS(sDeal);
  return added;
}

/* ------- Finish / Result ------- */
function finishRound(){
  const ps=score(player), bs=score(banker);
  let winner = ps>bs ? 'player' : bs>ps ? 'banker' : 'tie';

  // update bead road
  history.push(winner[0]); // 'p' | 'b' | 't'
  const dot=document.createElement('div'); dot.className='bead ' + winner[0]; beads.prepend(dot);

  if(winner==='tie'){
    resultEl.textContent='Tie ‚Äî no voucher';
    codeBox.style.display='block'; codeBox.textContent='TRY-AGAIN-NEXT-TIME';
  } else {
    const youWin = (bet===winner);
    resultEl.textContent = youWin ? 'You win!' : (winner==='player'?'Player wins':'Banker wins');
    if(youWin){
      codeBox.style.display='block'; codeBox.textContent=CODE_WIN; copyBtn.style.display='inline-block';
      try{ localStorage.setItem(CLAIM_KEY, JSON.stringify({code:CODE_WIN, ts:Date.now()})); }catch(e){}
      playS(sWin); confetti();
    }else{
      codeBox.style.display='block'; codeBox.textContent=CODE_LOSE;
    }
  }

  if(cutReached){
    shoeNeedsShuffle = true;
    reshuffleBtn.style.display='inline-block';
    dealBtn.disabled=true;
    announce('Shoe finished ‚Äî reshuffle for next hand');
  }

  bet=null; dealt=false;
  betPlayer.disabled=false; betBanker.disabled=false;
  if(!shoeNeedsShuffle) dealBtn.disabled=true;
  resultEl.textContent += ' ‚Ä¢ Place a new bet to play again';
}

/* ------- Copy code ------- */
copyBtn.addEventListener('click',()=>{
  const t=codeBox.textContent.trim(); if(!t) return;
  navigator.clipboard.writeText(t).then(()=>{
    copyBtn.textContent='Copied!'; setTimeout(()=>copyBtn.textContent='Copy Code',1200);
  });
});

/* ------- Prior claim ------- */
try{
  const prior=localStorage.getItem(CLAIM_KEY);
  if(prior){
    const code=(JSON.parse(prior).code)||CODE_WIN;
    codeBox.style.display='block'; codeBox.textContent = code; copyBtn.style.display='inline-block';
    betPlayer.disabled=true; betBanker.disabled=true; dealBtn.disabled=true;
    resultEl.textContent='Voucher already claimed';
  }
}catch(e){}

/* ------- Boot shoe ------- */
initShoe();
</script>
</body>
</html>
