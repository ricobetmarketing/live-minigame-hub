<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Live ‚Äî Baccarat (Auto Flip ‚Ä¢ 3 Bets)</title>
<style>
  :root{
    --ink:#eaf2ff; --mut:#9fb0d9; --g1:#71e1ff; --g2:#25c3ff;
    --felt1:#184d57; --felt2:#0f2f35; --gold:#ffd86a;
    --pcol:#6cf5d4; --bcol:#ff9aa5; --tcol:#ffe39a;
    --cardW: clamp(62px, 9.2vw, 92px);         /* cards auto-scale */
    --cardH: calc(var(--cardW) * 1.39);
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    background:radial-gradient(1400px 900px at 70% -10%, #18244d 0%, #0a0f1e 55%, #05070d 100%);
    font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
    display:flex; align-items:center; justify-content:center; padding:8px;
  }
  a.back{position:fixed; left:10px; top:10px; z-index:50; text-decoration:none; background:rgba(0,0,0,.5); padding:8px 12px; border-radius:10px; color:#fff; font-weight:700}
  .wrap{ width:min(1200px,98vw) }
  .card{
    position:relative; border-radius:22px; padding:12px; overflow:visible;
    background:linear-gradient(180deg,#1b2a56,#0f1832);
    outline:1px solid rgba(255,255,255,.08); box-shadow:0 16px 60px rgba(0,0,0,.55);
  }

  /* top bar */
  .top{ display:grid; grid-template-columns:1fr auto auto; gap:8px; align-items:center; margin:2px 2px 8px }
  .shoe{ display:flex; align-items:center; gap:10px; background:rgba(0,0,0,.28); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:8px 10px; min-width:240px }
  .bar{ position:relative; flex:1; height:8px; border-radius:999px; background:#16213f; overflow:hidden }
  .bar>i{position:absolute; left:0; top:0; bottom:0; width:0%; background:linear-gradient(90deg,#65f0ff,#ff62ff)}
  .toggle{border:0;border-radius:12px;padding:8px 12px;font-weight:900;cursor:pointer;background:#2b2b2b;color:#fff}
  .note{font-size:12px; opacity:.9; white-space:nowrap}

  /* felt */
  .felt{
    position:relative;
    border-radius:22px;
    padding:14px 14px 150px;
    background:radial-gradient(closest-side,var(--felt1),var(--felt2));
    outline:1px solid rgba(255,255,255,.08);
    box-shadow:inset 0 0 70px rgba(0,0,0,.6), 0 0 60px rgba(113,225,255,.18), 0 0 80px rgba(192,107,255,.16);
    overflow:hidden;

    /* keep whole table visible on any screen */
    width:100%;
    aspect-ratio:16/9;
    max-height:calc(100vh - 110px);
  }
  #fx{ position:absolute; inset:0; pointer-events:none; z-index:2 }

  /* table label */
  .feltArt{ position:absolute; inset:0; pointer-events:none; opacity:.75; filter:drop-shadow(0 3px 10px rgba(0,0,0,.45)); z-index:0 }
  .feltArt text{ font:900 clamp(12px,1.9vw,18px)/1 ui-sans-serif,system-ui,Segoe UI,Roboto,Arial; letter-spacing:2px; fill:#eaf2ff }

  /* hands */
  .hand{ position:absolute; top:clamp(18px, 3.5vh, 34px); display:flex; gap:10px }
  .hand.player{ left:clamp(14px, 5vw, 60px) } 
  .hand.banker{ right:clamp(14px, 5vw, 60px) }
  .tot{ position:absolute; top:6px; font:900 clamp(11px,1.8vw,14px)/1 ui-sans-serif; color:var(--gold); text-shadow:0 2px 6px rgba(0,0,0,.6); transition:transform .18s }
  .tot.p{ left:clamp(14px, 5vw, 60px) } .tot.b{ right:clamp(14px, 5vw, 60px) }
  .tot.pop{ transform:scale(1.18) }

  /* betting areas */
  .areas{ position:absolute; inset:clamp(110px,18vh,160px) clamp(12px,6vw,70px) clamp(160px,24vh,220px); display:grid; grid-template-columns:1fr 1fr 1fr; gap:clamp(10px,2.6vw,28px); z-index:1 }
  .area{
    position:relative; border-radius:26px; display:grid; place-items:center;
    background:radial-gradient(closest-side, rgba(255,255,255,.05), rgba(255,255,255,.0) 70%);
    outline:2px dashed rgba(255,255,255,.15); padding:12px;
    transition: box-shadow .25s ease, transform .12s ease;
  }
  .area h2{ margin:0; font:900 clamp(16px,2.2vw,22px)/1.1 ui-sans-serif; letter-spacing:1px }
  .area small{ opacity:.8; font-weight:700; font-size:clamp(10px,1.5vw,12px) }
  .banker h2{ color:#ffc6c6 } .player h2{ color:#c6ffea } .tie h2{ color:#ffe39a }

  .betSpot{ position:absolute; bottom:14px; left:50%; transform:translateX(-50%); width:clamp(90px,12vw,150px); height:clamp(90px,12vw,150px); border-radius:50%;
            box-shadow:inset 0 0 0 6px rgba(255,255,255,.15); background:radial-gradient(circle, rgba(255,255,255,.08), rgba(255,255,255,0) 65%); cursor:pointer }
  .area.sel{ transform:translateY(-2px); box-shadow:0 0 18px rgba(113,225,255,.35) inset, 0 0 26px rgba(113,225,255,.22) }
  .area.winPulse{ animation:pulseGlow 1.1s ease-in-out 3 }
  @keyframes pulseGlow{
    0%,100%{ box-shadow:0 0 0 0 rgba(255,255,255,.0), 0 0 0 0 rgba(255,255,255,.0)}
    50%{ box-shadow:0 0 22px 8px rgba(255,255,255,.18), 0 0 60px 14px rgba(255,255,255,.12) }
  }

  /* 3D auto flip cards */
  .playing-card{ width:var(--cardW); height:var(--cardH); border-radius:14px; position:relative; outline:2px solid #e5ecff; box-shadow:0 16px 28px rgba(0,0,0,.4); perspective:1000px }
  .card3d{
    position:absolute; inset:0; border-radius:14px;
    transition:transform .48s ease;
    transform:rotateY(0deg);
    transform-style:preserve-3d; -webkit-transform-style:preserve-3d;
    will-change:transform;
  }
  .sideFace{
    position:absolute; inset:0; display:grid; place-items:center; border-radius:14px; font-weight:900;
    backface-visibility:hidden; -webkit-backface-visibility:hidden;
  }
  .back{ background:linear-gradient(180deg,#0e1a3a,#0a1329); color:#9fb0d9; font-size:clamp(20px,3.4vw,28px); transform:rotateY(0deg) }
  .front{ background:radial-gradient(240px 160px at 50% -20%,#fff,#e9eefc 40%,#c8d4f3 100%); color:#1a2050; font-size:clamp(18px,3vw,26px); transform:rotateY(180deg) }
  .reveal .card3d{ transform:rotateY(180deg) }
  .deal-in{ opacity:0; transform:translateY(-24px) scale(.96); animation:deal .42s cubic-bezier(.2,.8,.2,1) forwards }
  @keyframes deal{to{opacity:1; transform:translateY(0) scale(1)}}

  /* controls */
  .controls{ position:absolute; left:50%; bottom:10px; transform:translateX(-50%); display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:center; z-index:3 }
  .btn{border:0; border-radius:14px; padding:10px 16px; font-weight:900; cursor:pointer; background:linear-gradient(to right,var(--g1),var(--g2)); color:#061018; box-shadow:0 0 18px rgba(113,225,255,.5), inset 0 -3px 0 rgba(0,0,0,.35)}
  .btn.ghost{background:#2b2b2b;color:#fff}
  .btn:disabled{opacity:.55}

  /* banner + progress */
  .banner{ position:absolute; right:10px; top:10px; background:rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:8px 12px; font-weight:900; z-index:3; font-size:clamp(12px,1.8vw,14px) }

  /* WINNER overlay */
  .winner{
    position:absolute; inset:0; display:none; place-items:center; z-index:4;
    background:radial-gradient(100% 60% at 50% 0%, rgba(255,255,255,.08), rgba(0,0,0,.0) 60%);
    pointer-events:none;
  }
  .winner.show{ display:grid; animation:fadeOut 2.1s ease forwards }
  @keyframes fadeOut{ 0%{opacity:1} 85%{opacity:1} 100%{opacity:0} }
  .winBadge{
    padding:14px 22px; border-radius:18px; font:900 clamp(18px,3.8vw,32px)/1 ui-sans-serif; letter-spacing:1px;
    color:#061018; background:linear-gradient(90deg,#71e1ff,#25c3ff); box-shadow:0 0 24px rgba(113,225,255,.6);
    text-shadow:none;
  }
  .winBadge.player{ background:linear-gradient(90deg,#aaffef,#71f1d6)}
  .winBadge.banker{ background:linear-gradient(90deg,#ffc6cf,#ff9aa5)}
  .winBadge.tie{ background:linear-gradient(90deg,#fff0b5,#ffd86a)}

  /* Voucher modal */
  .overlay{ position:fixed; inset:0; background:rgba(0,0,12,.86); display:none; place-items:center; z-index:999; backdrop-filter: blur(4px) }
  .overlay.show{ display:grid }
  .modal{
    width:min(520px,92vw); border-radius:20px; padding:18px; text-align:center;
    background:radial-gradient(120% 120% at 50% 0%, #1a1740 0%, #0d1230 60%);
    outline:1px solid rgba(180,220,255,.25); box-shadow:0 24px 90px rgba(0,0,0,.75);
    transform:scale(.96); animation:popIn .28s ease forwards; color:#eaf2ff
  }
  @keyframes popIn{to{transform:scale(1)}}
  .voucher{
    font-family:ui-monospace,SFMono-Regular,Menlo,monospace;
    font-size:clamp(16px,3.8vw,20px);
    letter-spacing:.6px; padding:12px 14px; border-radius:12px;
    color:#d8b6ff; background:#0a0d1a; display:inline-block;
    outline:1px dashed rgba(160,220,255,.4); margin:10px 0 6px;
  }
  .row{display:flex; gap:10px; justify-content:center; margin-top:10px; flex-wrap:wrap}
  .copy,.close{cursor:pointer; border:0; border-radius:12px; padding:10px 14px; font-weight:900; font-size:clamp(13px,3.6vw,14px)}
  .copy{background:#2b2b2b; color:#fff} .close{background:#fff; color:#111}

  /* Small devices tweaks */
  @media (max-width:600px){
    .felt{ padding-bottom:140px }
    .areas{ inset:clamp(90px,18vh,150px) clamp(8px,5vw,16px) clamp(140px,22vh,200px) }
  }
</style>
</head>
<body>
  <a class="back" href="index.html">‚Üê Back</a>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div class="shoe"><div style="font-weight:800">Shoe</div><div class="bar"><i id="shoeFill"></i></div><div id="shoeLeft" style="font-size:12px;min-width:64px;text-align:right">‚Äî</div></div>
        <div class="note"><b>3 bets only</b> ‚Ä¢ Voucher after 3 bets ‚Ä¢ Banker 0.95:1 ‚Ä¢ Player 1:1 ‚Ä¢ Tie 8:1</div>
        <button id="soundBtn" class="toggle">üîä Sound: On</button>
      </div>

      <div class="felt" id="felt">
        <canvas id="fx"></canvas>

        <!-- curved table label -->
        <svg class="feltArt" viewBox="0 0 1200 700" preserveAspectRatio="none" aria-hidden="true">
          <defs><path id="arc1" d="M200,360 A420,260 0 0,1 1000,360"/></defs>
          <text style="font-size:26px"><textPath href="#arc1" startOffset="50%" text-anchor="middle">BACCARAT ‚Äî AUTO FLIP</textPath></text>
        </svg>

        <!-- totals -->
        <div class="tot p" id="pTot">Player: ‚Äî</div>
        <div class="tot b" id="bTot">Banker: ‚Äî</div>

        <!-- hands -->
        <div class="hand player" id="pHand"></div>
        <div class="hand banker" id="bHand"></div>

        <!-- betting areas (tap to select one) -->
        <div class="areas">
          <div class="area player" id="areaPlayer">
            <h2>PLAYER</h2><small>1 : 1</small>
            <div class="betSpot" id="spotPlayer" title="Bet Player"></div>
          </div>
          <div class="area tie" id="areaTie">
            <h2>TIE</h2><small>8 : 1</small>
            <div class="betSpot" id="spotTie" title="Bet Tie"></div>
          </div>
          <div class="area banker" id="areaBanker">
            <h2>BANKER</h2><small>0.95 : 1</small>
            <div class="betSpot" id="spotBanker" title="Bet Banker"></div>
          </div>
        </div>

        <!-- controls -->
        <div class="controls">
          <button class="btn" id="dealBtn" disabled>Deal</button>
          <div class="btn ghost" id="progress">Bets left: 3 ‚Ä¢ Wins: 0</div>
        </div>

        <!-- banner -->
        <div class="banner" id="banner">Select a side</div>

        <!-- WINNER overlay -->
        <div class="winner" id="winnerOverlay"><div class="winBadge" id="winBadge">PLAYER WIN</div></div>
      </div>
    </div>
  </div>

<!-- Voucher Modal -->
<div class="overlay" id="voucherOverlay" role="dialog" aria-modal="true">
  <div class="modal">
    <div style="font-weight:900; font-size:clamp(16px,4.2vw,22px); margin-bottom:6px">Your Voucher</div>
    <div class="voucher" id="voucherText">VIPBAW</div>
    <div class="row">
      <button class="copy" id="copyBtn">Copy Code</button>
      <button class="close" id="closeBtn">Close</button>
    </div>
    <div style="color:#a9b7d8;margin-top:8px; font-size:12px">Use this code in your account. One play per user.</div>
  </div>
</div>

<!-- SFX -->
<audio id="sDeal"    preload="auto" src="https://cdn.jsdelivr.net/gh/naptha/tinyfiles@main/slot/lever.mp3"></audio>
<audio id="sFlip"    preload="auto" src="https://cdn.jsdelivr.net/gh/naptha/tinyfiles@main/slot/stop.mp3"></audio>
<audio id="sWin"     preload="auto" src="https://cdn.jsdelivr.net/gh/naptha/tinyfiles@main/slot/win.mp3"></audio>
<audio id="sClick"   preload="auto" src="https://cdn.jsdelivr.net/gh/naptha/tinyfiles@main/click/click2.mp3"></audio>
<audio id="sShuffle" preload="auto" src="https://cdn.jsdelivr.net/gh/naptha/tinyfiles@main/slot/win.mp3"></audio>

<script>
/* ===== Fallback realm helpers (so this file works alone) ===== */
if(typeof getChoice!=='function') window.getChoice=()=>{try{return localStorage.getItem('realm_choice')}catch(e){return null}};
if(typeof setChoice!=='function') window.setChoice=v=>{try{localStorage.setItem('realm_choice',v)}catch(e){}};

/* ===== Constants for this flow ===== */
const MAX_ROUNDS = 3;
const CLAIM_KEY  = 'live_bac_3bets_claimed_v1';      // blocks replay after voucher
const PROG_KEY   = 'live_bac_3bets_progress_v1';     // keeps rounds/wins progress
const CODE_WIN   = 'VIPBAW';
const CODE_LOSE  = 'VIPBAL';

/* ===== Mobile/Desktop audio handling ===== */
let soundOn=true, audioUnlocked=false;
const sDeal=g('sDeal'), sFlip=g('sFlip'), sWin=g('sWin'), sClick=g('sClick'), sShuffle=g('sShuffle');
function unlockAudio(){
  if(audioUnlocked) return;
  [sDeal,sFlip,sWin,sClick,sShuffle].forEach(a=>{
    try{
      a.play().then(()=>{ a.pause(); a.currentTime=0; audioUnlocked=true; }).catch(()=>{ /* still locked; next tap will try again */ });
    }catch(e){}
  });
}
function playS(a){ if(!soundOn) return; if(!audioUnlocked) return; try{ a.currentTime=0; a.play().catch(()=>{});}catch(e){} }
g('soundBtn').addEventListener('click',e=>{
  soundOn=!soundOn; e.target.textContent = soundOn?'üîä Sound: On':'üîà Sound: Off';
  unlockAudio();
});
document.addEventListener('pointerdown', unlockAudio, {once:true});

/* ===== Canvas confetti ===== */
const fx=g('fx'), ctx=fx.getContext('2d');
function resizeFX(){ fx.width=fx.parentElement.clientWidth; fx.height=fx.parentElement.clientHeight }
addEventListener('resize',resizeFX); addEventListener('orientationchange',()=>setTimeout(resizeFX,200)); resizeFX();
function confetti(){ const p=[]; for(let i=0;i<160;i++) p.push({x:fx.width/2,y:120+Math.random()*20,vx:(Math.random()-0.5)*6,vy:(Math.random()-0.5)*5,life:140+Math.random()*60,r:2+Math.random()*3,h:Math.random()*360}); (function loop(){ ctx.clearRect(0,0,fx.width,fx.height); p.forEach(o=>{o.x+=o.vx;o.y+=o.vy;o.vy+=0.06;o.life--;ctx.globalAlpha=Math.max(0,o.life/200);ctx.fillStyle=`hsl(${o.h},100%,60%)`;ctx.fillRect(o.x,o.y,o.r,o.r);}); ctx.globalAlpha=1; if(p.some(o=>o.life>0)) requestAnimationFrame(loop); })(); }

/* ===== Helpers ===== */
function g(id){return document.getElementById(id)}
function delay(ms){ return new Promise(r=>setTimeout(r,ms)) }

/* ===== DOM refs ===== */
const pHand=g('pHand'), bHand=g('bHand'), banner=g('banner');
const shoeFill=g('shoeFill'), shoeLeft=g('shoeLeft');
const pTot=g('pTot'), bTot=g('bTot');
const dealBtn=g('dealBtn'), progress=g('progress');
const areaPlayer=g('areaPlayer'), areaBanker=g('areaBanker'), areaTie=g('areaTie');
const winnerOverlay=g('winnerOverlay'), winBadge=g('winBadge');
const voucherOverlay=g('voucherOverlay'), voucherText=g('voucherText'), copyBtn=g('copyBtn'), closeBtn=g('closeBtn');

/* ===== State (no balances; only rounds) ===== */
let shoe=[], shoeSize=0, cutLine=52, cutReached=false;
let inRound=false, P=[], B=[];
let selection=null;  // 'player' | 'banker' | 'tie'
let roundsPlayed=0, winsCount=0;

/* ===== Prevent playing if already claimed ===== */
const claimedRaw = localStorage.getItem(CLAIM_KEY);
if(claimedRaw){
  const saved = JSON.parse(claimedRaw);
  selectionLock(true);
  showVoucher(saved.code || CODE_LOSE, false);
}

/* Resume progress if any */
try{
  const prog = JSON.parse(localStorage.getItem(PROG_KEY) || 'null');
  if(prog && !claimedRaw){
    roundsPlayed = Math.min(MAX_ROUNDS, prog.roundsPlayed||0);
    winsCount    = Math.max(0, prog.winsCount||0);
  }
}catch(e){}
updateProgress();

/* ===== Shoe / Cards ===== */
function makeShoe(){ const ranks=['A','2','3','4','5','6','7','8','9','10','J','Q','K'], suits=['‚ô†','‚ô•','‚ô¶','‚ô£']; const d=[]; for(let k=0;k<6;k++){ for(const s of suits){ for(const r of ranks){ d.push({r,s}) } } } for(let i=d.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [d[i],d[j]]=[d[j],d[i]] } return d }
function initShoe(){
  shoe=makeShoe(); shoeSize=shoe.length; cutLine = 52 + ((Math.random()*26)|0); cutReached=false; updateShoeBar();
  const burn=shoe.pop(); let burnN = bacVal(burn.r); if(burnN===10) burnN=10; for(let i=0;i<burnN;i++) shoe.pop(); playS(sShuffle); updateShoeBar();
}
function draw(){ const c=shoe.pop(); updateShoeBar(); return c }
function updateShoeBar(){ const left=shoe.length; shoeLeft.textContent=`${left}`; shoeFill.style.width=Math.round((left/shoeSize)*100)+'%' }

function bacVal(r){ if(r==='A')return 1; if(['10','J','Q','K'].includes(r)) return 0; return Number(r) }
function total(hand){ return hand.reduce((t,c)=>t+bacVal(c.r),0)%10 }

function makeCardEl(c, show=false){
  const el=document.createElement('div'); el.className='playing-card deal-in'+(show?' reveal':'');
  el.innerHTML=`<div class="card3d">
      <div class="sideFace back">üÇ†</div>
      <div class="sideFace front">${c.r}${c.s}</div>
    </div>`;
  c.el=el; c.shown=!!show; return el;
}
function flip(c){ if(c.shown) return; c.shown=true; c.el.classList.add('reveal'); playS(sFlip); }

/* ===== Selection (tap area) ===== */
function selectionLock(lock){
  const areas=[areaPlayer, areaBanker, areaTie];
  areas.forEach(a=>{ a.style.pointerEvents = lock?'none':'auto'; if(lock) a.classList.remove('sel'); });
  if(lock){ dealBtn.disabled=true; selection=null; }
}
function setSelection(side){
  if(inRound) return;
  [areaPlayer, areaBanker, areaTie].forEach(a=>a.classList.remove('sel'));
  if(side==='player') areaPlayer.classList.add('sel');
  if(side==='banker') areaBanker.classList.add('sel');
  if(side==='tie')    areaTie.classList.add('sel');
  selection = side;
  banner.textContent = `Selected: ${side.toUpperCase()} ‚Ä¢ Tap DEAL`;
  dealBtn.disabled=false;
  unlockAudio();
}
g('spotPlayer').addEventListener('click',()=>{ setChoice('live'); setSelection('player'); playS(sClick); });
g('spotBanker').addEventListener('click',()=>{ setChoice('live'); setSelection('banker'); playS(sClick); });
g('spotTie').addEventListener('click',   ()=>{ setChoice('live'); setSelection('tie');    playS(sClick); });

/* ===== Flow timings ===== */
const dealDelay = 140;
const flipDelay = 360;
const thirdDelay = 420;
const popMs = 220;

function popTotals(){
  pTot.classList.add('pop'); bTot.classList.add('pop');
  setTimeout(()=>{ pTot.classList.remove('pop'); bTot.classList.remove('pop'); }, popMs);
}

/* ===== Round ===== */
dealBtn.addEventListener('click', startRound);

async function startRound(){
  if(inRound) return;
  if(!selection) return alert('Select Player / Banker / Tie first.');
  inRound=true; dealBtn.disabled=true;
  playS(sDeal); unlockAudio();

  P=[]; B=[]; pHand.innerHTML=''; bHand.innerHTML='';
  banner.textContent='Dealing‚Ä¶';
  [areaPlayer, areaBanker, areaTie].forEach(a=>a.classList.remove('winPulse'));
  updateTotals();

  // two down cards each
  await dealDownTo(P, pHand); await delay(dealDelay);
  await dealDownTo(B, bHand); await delay(dealDelay);
  await dealDownTo(P, pHand); await delay(dealDelay);
  await dealDownTo(B, bHand); await delay(dealDelay);

  // flip P1 B1 P2 B2
  await flipCard(P[0]); await delay(flipDelay); updateTotals(); popTotals();
  await flipCard(B[0]); await delay(flipDelay); updateTotals(); popTotals();
  await flipCard(P[1]); await delay(flipDelay); updateTotals(); popTotals();
  await flipCard(B[1]); await delay(flipDelay); updateTotals(); popTotals();

  // natural?
  if(total(P)>=8 || total(B)>=8){ await finishRound(); return; }

  // player third?
  let playerThird=null;
  if(total(P)<=5){
    await dealDownTo(P, pHand); await delay(thirdDelay);
    await flipCard(P[2]); updateTotals(); popTotals();
    playerThird = P[2];
  }

  // banker third?
  const bT0 = (B.length>=2)? total([B[0],B[1]]) : total(B);
  let needBanker=false;
  if(!playerThird){
    needBanker = bT0<=5;
  }else{
    const v = bacVal(playerThird.r);
    needBanker = bankerDrawRule(bT0, v);
  }
  if(needBanker){
    await dealDownTo(B, bHand); await delay(thirdDelay);
    await flipCard(B[2]); updateTotals(); popTotals();
  }

  await finishRound();
}

function bankerDrawRule(b, v){
  if(b<=2) return true;
  if(b===3) return v!==8;
  if(b===4) return v>=2 && v<=7;
  if(b===5) return v>=4 && v<=7;
  if(b===6) return v===6 || v===7;
  return false;
}

async function dealDownTo(hand, container){
  const c=draw(); const card={r:c.r,s:c.s,shown:false};
  hand.push(card); container.appendChild(makeCardEl(card,false));
}
async function flipCard(card){ flip(card); await delay(220); }

async function finishRound(){
  const pT=total(P), bT=total(B);
  updateTotals();

  let winner = (pT>bT)?'player' : (bT>pT)?'banker':'tie';
  const badgeTxt = winner==='tie' ? `TIE ‚Äî ${pT}` : `${winner.toUpperCase()} WIN ‚Äî ${winner==='player'?pT:bT}`;
  showWinner(winner, badgeTxt);

  // user win?
  const userWin = (selection===winner);
  if(userWin) winsCount++;

  roundsPlayed++;
  saveProgress();

  const left = Math.max(0, MAX_ROUNDS - roundsPlayed);
  progress.textContent = `Bets left: ${left} ‚Ä¢ Wins: ${winsCount}`;

  // Prompt next or finish
  if(roundsPlayed >= MAX_ROUNDS){
    await delay(600);
    const code = (winsCount>0) ? CODE_WIN : CODE_LOSE;
    finalizeVoucher(code);
  }else{
    banner.textContent = `Result: ${badgeTxt} ‚Ä¢ Select next bet (${left} left)`;
    selection = null;
    [areaPlayer, areaBanker, areaTie].forEach(a=>a.classList.remove('sel'));
    inRound=false;
  }
}

function showWinner(winner, text){
  winBadge.textContent=text;
  winBadge.className='winBadge '+(winner==='player'?'player':winner==='banker'?'banker':'tie');
  winnerOverlay.classList.remove('show'); void winnerOverlay.offsetWidth;
  winnerOverlay.classList.add('show');
  [areaPlayer, areaBanker, areaTie].forEach(a=>a.classList.remove('winPulse'));
  if(winner==='player') areaPlayer.classList.add('winPulse');
  else if(winner==='banker') areaBanker.classList.add('winPulse');
  else areaTie.classList.add('winPulse');
  banner.textContent=text;
}

/* ===== Voucher handling (one play per user) ===== */
function finalizeVoucher(code){
  playS(sWin); confetti();
  showVoucher(code, true);
  localStorage.setItem(CLAIM_KEY, JSON.stringify({code, ts:Date.now()}));
  selectionLock(true);
  inRound=false;
}
function showVoucher(code, allowClose){
  voucherText.textContent = code;
  voucherOverlay.classList.add('show');
  copyBtn.onclick = ()=>{ const t=voucherText.textContent.trim(); if(!t) return; navigator.clipboard.writeText(t).then(()=>{ copyBtn.textContent='Copied!'; setTimeout(()=>copyBtn.textContent='Copy Code',1000); }); };
  if(allowClose){
    closeBtn.onclick = ()=> voucherOverlay.classList.remove('show');
  }else{
    closeBtn.onclick = ()=> voucherOverlay.classList.remove('show');
  }
}

/* ===== Totals UI ===== */
function updateTotals(){
  pTot.textContent='Player: '+ (P.some(c=>c.shown)? total(P):'‚Äî');
  bTot.textContent='Banker: '+ (B.some(c=>c.shown)? total(B):'‚Äî');
  progress.textContent = `Bets left: ${Math.max(0, MAX_ROUNDS - roundsPlayed)} ‚Ä¢ Wins: ${winsCount}`;
}

/* ===== Persist progress across refresh (but still one-time) ===== */
function saveProgress(){
  try{ localStorage.setItem(PROG_KEY, JSON.stringify({roundsPlayed, winsCount})); }catch(e){}
}

/* ===== Init ===== */
function init(){
  const lockedTo = getChoice(); if(lockedTo && lockedTo!=='live'){ alert('You already started Slot. Live is locked for this event.'); location.replace('index.html'); }
  initShoe();
  banner.textContent = 'Select a side';
}
init();
</script>
</body>
</html>
