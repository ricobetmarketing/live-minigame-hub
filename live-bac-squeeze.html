<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Live ‚Äî Premier Blackjack (Real Table)</title>
<style>
  :root{
    --ink:#eaf2ff; --mut:#9fb0d9; --g1:#71e1ff; --g2:#25c3ff;
    --felt1:#154a44; --felt2:#0e332f;
    --gold:#ffd86a; --shadow:rgba(0,0,0,.55);
    --seatOn:#ffffff;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    background:radial-gradient(1400px 900px at 70% -10%, #18244d 0%, #0a0f1e 55%, #05070d 100%);
    font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
    display:flex; align-items:center; justify-content:center; padding:12px;
  }
  a.back{position:fixed; left:12px; top:12px; z-index:50; text-decoration:none; background:rgba(0,0,0,.5); padding:8px 12px; border-radius:10px; color:#fff; font-weight:700}
  .wrap{ width:min(1200px,98vw) }
  .card{
    position:relative; border-radius:22px; padding:16px; overflow:visible;
    background:linear-gradient(180deg,#1b2a56,#0f1832);
    outline:1px solid rgba(255,255,255,.08); box-shadow:0 16px 60px rgba(0,0,0,.55);
  }

  /* top bar */
  .top{ display:grid; grid-template-columns:1fr auto auto; gap:10px; align-items:center; margin:2px 2px 10px }
  .shoe{ display:flex; align-items:center; gap:10px; background:rgba(0,0,0,.28); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:8px 10px; min-width:270px }
  .bar{ position:relative; flex:1; height:8px; border-radius:999px; background:#16213f; overflow:hidden }
  .bar>i{position:absolute; left:0; top:0; bottom:0; width:0%; background:linear-gradient(90deg,#65f0ff,#ff62ff)}
  .toggle{border:0;border-radius:12px;padding:8px 12px;font-weight:900;cursor:pointer;background:#2b2b2b;color:#fff}
  .note{font-size:12px; opacity:.9; white-space:nowrap}

  /* felt (FIX: real height so nothing is clipped) */
  .felt{
    position:relative;
    border-radius:22px;
    padding:18px 18px 160px;                /* more room at bottom for seats/controls */
    background:radial-gradient(closest-side,var(--felt1),var(--felt2));
    outline:1px solid rgba(255,255,255,.08);
    box-shadow:inset 0 0 70px rgba(0,0,0,.6), 0 0 60px rgba(113,225,255,.18), 0 0 80px rgba(192,107,255,.16);
    overflow:hidden;
    min-height: clamp(600px, 76vh, 880px); /* üëà keeps the whole table visible */
    aspect-ratio: 16 / 9;
  }
  #fx{ position:absolute; inset:0; pointer-events:none; z-index:2 }
  .feltArt{ position:absolute; inset:0; pointer-events:none; opacity:.65; filter:drop-shadow(0 3px 10px rgba(0,0,0,.45)); z-index:0 }
  .feltArt text{ font:900 18px/1 ui-sans-serif,system-ui,Segoe UI,Roboto,Arial; letter-spacing:2.2px; fill:#eaf2ff }

  /* dealer area */
  .dealerArea{ position:absolute; left:0; right:0; top:70px; display:flex; align-items:center; justify-content:center; gap:14px; z-index:1 }
  .dealerLabel{
    position:absolute; top:-38px; left:50%; transform:translateX(-50%);
    background:rgba(0,0,0,.32); border:1px solid rgba(255,255,255,.12); padding:6px 10px; border-radius:10px; font-weight:900;
    pointer-events:none; z-index:1;
  }

  /* seats */
  .seats{
    position:absolute; left:0; right:0;
    bottom:140px;                          /* FIX: lifted above controls */
    display:grid; grid-template-columns:repeat(4,1fr);
    gap:20px; padding:0 80px; z-index:1;
  }
  .seat{ position:relative; height:150px; display:grid; place-items:center; cursor:pointer }
  .ring{
    position:absolute; inset:auto 0 12px 0; margin:auto; width:170px; height:170px; border-radius:50%;
    box-shadow:inset 0 0 0 5px rgba(255,255,255,.12), 0 12px 24px rgba(0,0,0,.4);
    background:radial-gradient(closest-side, rgba(255,255,255,.06), rgba(255,255,255,0) 60%);
    pointer-events:auto;
  }
  .ring.on{ box-shadow:inset 0 0 0 6px var(--seatOn), 0 16px 40px rgba(0,0,0,.55) }
  .seatNum{ position:absolute; inset:auto 0 58px 0; margin:auto; width:72px; height:72px; border-radius:50%; display:grid; place-items:center; font-weight:900; color:#0b1111; background:#eaeaea; border:6px solid #c0c9c5 }
  .seatNum.on{ background:#fff; border-color:#fff }
  .betStack{ position:absolute; inset:auto 0 26px 0; margin:auto; width:96px; height:72px; pointer-events:none }
  .betAmt{ position:absolute; left:50%; transform:translateX(-50%); bottom:-22px; font:900 12px/1 ui-sans-serif; color:#eaf2ff; text-shadow:0 2px 6px rgba(0,0,0,.6) }

  /* player hand containers */
  .hand{ position:absolute; top:-18px; display:flex; gap:10px }
  .handPlayer{ left:18px }

  /* cards 3D */
  .playing-card{ width:92px; height:128px; border-radius:14px; position:relative; transform:translateZ(0); outline:2px solid #e5ecff; box-shadow:0 16px 28px rgba(0,0,0,.4) }
  .card3d{ position:absolute; inset:0; border-radius:14px; transform-style:preserve-3d; backface-visibility:hidden; transition:transform .48s ease }
  .sideFace{ position:absolute; inset:0; display:grid; place-items:center; border-radius:14px; backface-visibility:hidden; -webkit-backface-visibility:hidden; font-weight:900 }
  .back{ background:linear-gradient(180deg,#0e1a3a,#0a1329); color:#9fb0d9; font-size:28px; transform:rotateY(0deg) }
  .front{ background:radial-gradient(240px 160px at 50% -20%,#fff,#e9eefc 40%,#c8d4f3 100%); color:#1a2050; font-size:26px; transform:rotateY(180deg) }
  .reveal .card3d{ transform:rotateY(180deg) }
  .deal-in{ opacity:0; transform:translateY(-30px) scale(.96); animation:deal .42s cubic-bezier(.2,.8,.2,1) forwards }
  @keyframes deal{to{opacity:1; transform:translateY(0) scale(1)}}

  /* chip tray */
  .tray{ position:absolute; left:24px; bottom:16px; display:flex; gap:10px; align-items:flex-end; z-index:3 }
  .chipSel{ width:56px; height:56px; border-radius:50%; display:grid; place-items:center; font-weight:900; color:#091020; background:radial-gradient(circle at 35% 35%, #fff, #f7f7f7 40%, #ddd 70%, #bbb 100%); border:6px solid #9be2ff; cursor:pointer; box-shadow:0 12px 28px rgba(0,0,0,.45); transition:transform .12s, box-shadow .12s }
  .chipSel.sel{ transform:translateY(-4px) scale(1.05); box-shadow:0 16px 40px rgba(0,0,0,.6) }
  .chipSel[data-v="5"]{ border-color:#7dfcc8 } .chipSel[data-v="25"]{ border-color:#ffd86a } .chipSel[data-v="100"]{ border-color:#ff9abb }

  /* controls */
  .controls{ position:absolute; left:50%; bottom:12px; transform:translateX(-50%); display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:center; z-index:3 }
  .btn{border:0; border-radius:14px; padding:12px 18px; font-weight:900; cursor:pointer; background:linear-gradient(to right,var(--g1),var(--g2)); color:#061018; box-shadow:0 0 18px rgba(113,225,255,.5), inset 0 -3px 0 rgba(0,0,0,.35)}
  .btn.ghost{background:#2b2b2b;color:#fff}
  .btn:disabled{opacity:.55}
  .bank{ background:rgba(0,0,0,.28); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:8px 10px; color:#cfe0ff }

  /* banner + voucher */
  .banner{ position:absolute; right:14px; top:14px; background:rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:8px 12px; font-weight:900; z-index:3 }
  .code{display:none; position:absolute; right:14px; bottom:16px; font-family:ui-monospace,SFMono-Regular,Menlo,monospace; letter-spacing:.5px; padding:10px 12px; border-radius:12px; background:#0a0d1a; outline:1px dashed rgba(160,220,255,.35); z-index:3}
  .copy{display:none;margin-left:8px;border:0;border-radius:10px;padding:8px 10px;font-weight:900;background:#2b2b2b;color:#fff; position:absolute; right:14px; bottom:16px; transform:translateY(46px); z-index:3}

  /* insurance prompt */
  .insBox{ position:absolute; left:50%; top:46%; transform:translate(-50%,-50%); background:rgba(0,0,0,.6); border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:14px 16px; display:none; z-index:4; backdrop-filter: blur(2px) }
  .insBox.show{ display:block }
  .insBox h3{ margin:0 0 8px; font-size:16px }
  .insRow{ display:flex; gap:10px; justify-content:center }

  /* chip pile animation */
  @keyframes chipDrop{ from{ transform:translate(-50%,10px); opacity:.6 } to{ transform:translate(-50%,0); opacity:1 } }
</style>
</head>
<body>
  <a class="back" href="index.html">‚Üê Back</a>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div class="shoe"><div style="font-weight:800">Shoe</div><div class="bar"><i id="shoeFill"></i></div><div id="shoeLeft" style="font-size:12px;min-width:70px;text-align:right">‚Äî</div></div>
        <div class="note">Blackjack pays <b>3 to 2</b> ‚Äî Insurance pays <b>2 to 1</b> ‚Äî Dealer must stand on all 17</div>
        <button id="soundBtn" class="toggle">üîä Sound: On</button>
      </div>

      <div class="felt" id="felt">
        <canvas id="fx"></canvas>

        <!-- curved felt text -->
        <svg class="feltArt" viewBox="0 0 1200 700" preserveAspectRatio="none" aria-hidden="true">
          <defs>
            <path id="arc1" d="M200,340 A420,260 0 0,1 1000,340" />
            <path id="arc2" d="M250,390 A380,220 0 0,1 950,390" />
          </defs>
          <text style="font-size:26px"><textPath href="#arc1" startOffset="50%" text-anchor="middle">PREMIER BLACKJACK</textPath></text>
          <text><textPath href="#arc2" startOffset="50%" text-anchor="middle">DEALER MUST STAND ON ALL 17</textPath></text>
        </svg>

        <!-- dealer -->
        <div class="dealerArea">
          <div class="dealerLabel">Dealer</div>
          <div id="dealerHand" class="hand"></div>
        </div>

        <!-- seats -->
        <div class="seats" id="seats">
          <div class="seat" data-seat="1">
            <div class="ring"></div><div class="seatNum">1</div>
            <div class="betStack"><div class="betAmt">$0</div></div>
            <div class="hand handPlayer" id="hand-1"></div>
          </div>
          <div class="seat" data-seat="2">
            <div class="ring"></div><div class="seatNum">2</div>
            <div class="betStack"><div class="betAmt">$0</div></div>
            <div class="hand handPlayer" id="hand-2"></div>
          </div>
          <div class="seat" data-seat="3">
            <div class="ring"></div><div class="seatNum">3</div>
            <div class="betStack"><div class="betAmt">$0</div></div>
            <div class="hand handPlayer" id="hand-3"></div>
          </div>
          <div class="seat" data-seat="4">
            <div class="ring"></div><div class="seatNum">4</div>
            <div class="betStack"><div class="betAmt">$0</div></div>
            <div class="hand handPlayer" id="hand-4"></div>
          </div>
        </div>

        <!-- chip tray -->
        <div class="tray">
          <div class="chipSel sel" data-v="1">$1</div>
          <div class="chipSel" data-v="5">$5</div>
          <div class="chipSel" data-v="25">$25</div>
          <div class="chipSel" data-v="100">$100</div>
        </div>

        <!-- controls -->
        <div class="controls">
          <button class="btn" id="dealBtn" disabled>Deal</button>
          <button class="btn" id="hitBtn" disabled>Hit</button>
          <button class="btn ghost" id="standBtn" disabled>Stand</button>
          <button class="btn ghost" id="doubleBtn" disabled>Double</button>
          <button class="btn ghost" id="rebetBtn" disabled>Rebet</button>
          <button class="btn ghost" id="clearBtn" disabled>Clear Table</button>
          <button class="btn ghost" id="reshuffleBtn" style="display:none">Reshuffle Shoe</button>
          <div class="bank">Balance: <b id="bal">$1000</b> ‚Ä¢ Total Bet: <b id="bet">$0</b> ‚Ä¢ Last Result: <b id="last">$0</b></div>
        </div>

        <!-- insurance -->
        <div class="insBox" id="insBox">
          <h3>Dealer shows Ace ‚Äî Insurance?</h3>
          <div style="text-align:center;margin-bottom:8px">Up to half your bet. Pays 2:1 if dealer has blackjack.</div>
          <div class="insRow">
            <button class="btn" id="insYes">Insure</button>
            <button class="btn ghost" id="insNo">No Thanks</button>
          </div>
        </div>

        <!-- banner + voucher -->
        <div class="banner" id="banner">Place your bet</div>
        <div class="code" id="codeBox">LIVE-BJ-XXXX</div>
        <button class="copy" id="copyBtn">Copy</button>
      </div>
    </div>
  </div>

<!-- SFX -->
<audio id="sDeal"    src="https://cdn.jsdelivr.net/gh/naptha/tinyfiles@main/slot/lever.mp3" preload="auto"></audio>
<audio id="sFlip"    src="https://cdn.jsdelivr.net/gh/naptha/tinyfiles@main/slot/stop.mp3"  preload="auto"></audio>
<audio id="sWin"     src="https://cdn.jsdelivr.net/gh/naptha/tinyfiles@main/slot/win.mp3"   preload="auto"></audio>
<audio id="sChip"    src="https://cdn.jsdelivr.net/gh/naptha/tinyfiles@main/click/click2.mp3" preload="auto"></audio>
<audio id="sShuffle" src="https://cdn.jsdelivr.net/gh/naptha/tinyfiles@main/slot/win.mp3"   preload="auto"></audio>

<script>
/* Fallback realm helpers so this file works alone */
if(typeof getChoice!=='function') window.getChoice=()=>{try{return localStorage.getItem('realm_choice')}catch(e){return null}};
if(typeof setChoice!=='function') window.setChoice=v=>{try{localStorage.setItem('realm_choice',v)}catch(e){}};
const r=getChoice(); if(r && r!=='live'){ alert('You already started Slot. Live is locked for this event.'); location.replace('index.html'); }

const CLAIM_KEY='live_blackjack_pro_claimed_v1', CODE='LIVE-BJ-21';

/* AUDIO */
let soundOn=true; const sDeal=g('sDeal'), sFlip=g('sFlip'), sWin=g('sWin'), sChip=g('sChip'), sShuffle=g('sShuffle');
function playS(a){ if(soundOn){ try{ a.currentTime=0; a.play().catch(()=>{});}catch(e){} } }
g('soundBtn').addEventListener('click',e=>{ soundOn=!soundOn; e.target.textContent = soundOn?'üîä Sound: On':'üîà Sound: Off'; });
document.addEventListener('pointerdown',()=>{ [sDeal,sFlip,sWin,sChip,sShuffle].forEach(a=>{ try{ a.muted=true; a.play().then(()=>{ a.pause(); a.currentTime=0; a.muted=false; }); }catch(e){} }); },{once:true});

/* FX confetti */
const fx=g('fx'), ctx=fx.getContext('2d');
function resizeFX(){ fx.width=fx.parentElement.clientWidth; fx.height=fx.parentElement.clientHeight }
addEventListener('resize',resizeFX); addEventListener('orientationchange',()=>setTimeout(resizeFX,200)); resizeFX();
function confetti(){ const p=[]; for(let i=0;i<160;i++) p.push({x:fx.width/2,y:120+Math.random()*20,vx:(Math.random()-0.5)*6,vy:(Math.random()-0.5)*5,life:140+Math.random()*60,r:2+Math.random()*3,h:Math.random()*360}); (function loop(){ ctx.clearRect(0,0,fx.width,fx.height); p.forEach(o=>{o.x+=o.vx;o.y+=o.vy;o.vy+=0.06;o.life--;ctx.globalAlpha=Math.max(0,o.life/200);ctx.fillStyle=`hsl(${o.h},100%,60%)`;ctx.fillRect(o.x,o.y,o.r,o.r);}); ctx.globalAlpha=1; if(p.some(o=>o.life>0)) requestAnimationFrame(loop); })(); }

/* DOM helpers */
function g(id){return document.getElementById(id)}
const shoeFill=g('shoeFill'), shoeLeft=g('shoeLeft');
const dealerHand=g('dealerHand'), banner=g('banner');
const dealBtn=g('dealBtn'), hitBtn=g('hitBtn'), standBtn=g('standBtn'), doubleBtn=g('doubleBtn'), rebetBtn=g('rebetBtn'), clearBtn=g('clearBtn'), reshuffleBtn=g('reshuffleBtn');
const balEl=g('bal'), betEl=g('bet'), lastEl=g('last');
const codeBox=g('codeBox'), copyBtn=g('copyBtn');
const insBox=g('insBox'), insYes=g('insYes'), insNo=g('insNo');

/* STATE */
let balance=1000, lastRes=0, currentChip=1;
let activeSeat=1;
let bets=[0,0,0,0,0]; // 1..4 for seats
let insurances=[0,0,0,0,0];
let hands={}; // seat -> array of cards
let dealer=[], hiddenDown=null; // dealer[1] is down card
let inRound=false, firstAction=true, shoe=[], shoeSize=0, cutLine=52, cutReached=false;

/* CHIPS */
document.querySelectorAll('.chipSel').forEach(ch=>{
  ch.addEventListener('click',()=>{
    document.querySelectorAll('.chipSel').forEach(x=>x.classList.remove('sel'));
    ch.classList.add('sel');
    currentChip = Number(ch.dataset.v);
  });
});

/* One-click betting on a seat */
document.querySelectorAll('.seat').forEach(seat=>{
  const seatId = Number(seat.dataset.seat);
  seat.addEventListener('click',()=>{
    if(inRound) return;
    document.querySelectorAll('.ring').forEach(r=>r.classList.remove('on'));
    document.querySelectorAll('.seatNum').forEach(r=>r.classList.remove('on'));
    seat.querySelector('.ring').classList.add('on');
    seat.querySelector('.seatNum').classList.add('on');
    activeSeat = seatId;
    placeBet(seatId);
  });
});
document.querySelectorAll('.seat .ring, .seat .seatNum').forEach(el=>{
  el.addEventListener('click', (e)=>{
    e.stopPropagation();
    placeBet(Number(el.closest('.seat').dataset.seat));
  });
});

function placeBet(seat){
  if(inRound) return;
  if(balance < currentChip) { alert('Not enough balance'); return; }
  setChoice('live');

  balance -= currentChip;
  bets[seat] += currentChip;
  updateBank();
  renderStack(seat);
  playS(sChip);

  dealBtn.disabled  = totalBet() === 0 ? true:false;
  clearBtn.disabled = totalBet() === 0 ? true:false;
  rebetBtn.disabled = lastTotalBet() === 0 ? true:false;
}

function renderStack(seat){
  const holder = document.querySelector(`.seat[data-seat="${seat}"] .betStack`);
  const amtEl = holder.querySelector('.betAmt'); amtEl.textContent = money(bets[seat]);
  holder.querySelectorAll('.chip').forEach(x=>x.remove());
  const denoms=[100,25,5,1];
  const colors=['#ff9abb','#ffd86a','#7dfcc8','#9be2ff'];
  let left=bets[seat], h=0;
  denoms.forEach((d,i)=>{ let ct=Math.floor(left/d); left%=d; for(let k=0;k<ct;k++){ const chip=document.createElement('div'); chip.className='chip'; chip.style.cssText=`position:absolute; left:50%; transform:translateX(-50%); bottom:${h*8}px; width:30px; height:30px; border-radius:50%; background:radial-gradient(circle at 35% 35%, #fff, #f5f5f5 40%, #ddd 70%, #bbb 100%); border:4px solid ${colors[i]}; box-shadow:0 8px 18px rgba(0,0,0,.35); display:grid; place-items:center; font:900 11px ui-sans-serif; color:#091020; animation:chipDrop .18s ease;`; chip.textContent='$'+d; holder.appendChild(chip); h++; }});
}

function totalBet(){ return bets[1]+bets[2]+bets[3]+bets[4] }
function lastTotalBet(){ try{ const s=JSON.parse(localStorage.getItem('bj_lastbets'))||[0,0,0,0,0]; return s[1]+s[2]+s[3]+s[4] }catch(e){ return 0 } }
function money(n){ return '$'+n.toFixed(2).replace(/\.00$/,'') }
function updateBank(){ balEl.textContent=money(balance); betEl.textContent=money(totalBet()); lastEl.textContent=money(lastRes) }

/* SHOE (6 decks) */
function makeShoe(){ const ranks=['A','2','3','4','5','6','7','8','9','10','J','Q','K'], suits=['‚ô†','‚ô•','‚ô¶','‚ô£']; const d=[]; for(let k=0;k<6;k++){ for(const s of suits){ for(const r of ranks){ d.push({r,s}) } } } for(let i=d.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [d[i],d[j]]=[d[j],d[i]] } return d }
function initShoe(){ shoe=makeShoe(); shoeSize=shoe.length; cutLine = 52 + ((Math.random()*26)|0); cutReached=false; updateShoeBar(); const burn=shoe.pop(); let burnN = rankVal(burn.r); if(burnN===10) burnN=10; for(let i=0;i<burnN;i++) shoe.pop(); playS(sShuffle); updateShoeBar(); reshuffleBtn.style.display='none'; }
function draw(){ const c=shoe.pop(); updateShoeBar(); if(!cutReached && shoe.length<=cutLine){ cutReached=true; reshuffleBtn.style.display='inline-block'; } return c }
function updateShoeBar(){ const left=shoe.length; shoeLeft.textContent=`${left} left`; shoeFill.style.width=Math.round((left/shoeSize)*100)+'%' }

/* CARD VALUES */
function rankVal(r){ if(r==='A') return 11; if(['K','Q','J','10'].includes(r)) return 10; return Number(r) }
function handValue(arr){ let sum=0, aces=0; arr.forEach(c=>{ const v=rankVal(c.r); sum+=v; if(c.r==='A') aces++; }); while(sum>21 && aces>0){ sum-=10; aces--; } return sum }
function makeCardEl(c, show=false){ const el=document.createElement('div'); el.className='playing-card deal-in'+(show?' reveal':''); el.innerHTML=`<div class="card3d"><div class="sideFace back">üÇ†</div><div class="sideFace front">${c.r}${c.s}</div></div>`; c.el=el; return el }
function flip(c){ if(c.shown) return; c.shown=true; c.el.classList.add('reveal'); playS(sFlip); }

/* CONTROLS */
dealBtn.addEventListener('click', startRound);
hitBtn.addEventListener('click', ()=>playerHit(activeSeat));
standBtn.addEventListener('click', ()=>playerStand(activeSeat));
doubleBtn.addEventListener('click', ()=>playerDouble(activeSeat));
rebetBtn.addEventListener('click', doRebet);
clearBtn.addEventListener('click', clearTable);
reshuffleBtn.addEventListener('click', initShoe);
copyBtn.addEventListener('click',()=>{ const t=codeBox.textContent.trim(); if(!t)return; navigator.clipboard.writeText(t).then(()=>{ copyBtn.textContent='Copied!'; setTimeout(()=>copyBtn.textContent='Copy',1200);});});

/* ROUND FLOW */
let dealerUp=null;
function startRound(){
  if(inRound) return;
  if(totalBet()===0) return alert('Place a bet on a seat.');
  setChoice('live');

  inRound=true; firstAction=true; lastRes=0; banner.textContent='Dealing‚Ä¶';
  dealer=[]; dealerUp=null; hiddenDown=null;
  document.querySelectorAll('.handPlayer').forEach(h=>h.innerHTML=''); dealerHand.innerHTML=''; insurances=[0,0,0,0,0];

  hands={}; [1,2,3,4].forEach(s=>{ if(bets[s]>0){ hands[s]=[]; } });
  playS(sDeal);

  // deal: each seat 1 card up, dealer up, seats 2nd card up, dealer down
  Object.keys(hands).map(Number).sort((a,b)=>a-b).forEach(s=>{
    const c=draw(); const card={r:c.r,s:c.s,shown:true}; hands[s].push(card);
    document.getElementById('hand-'+s).appendChild(makeCardEl(card,true));
  });
  const up=draw(); dealerUp={r:up.r,s:up.s,shown:true}; dealer.push(dealerUp); dealerHand.appendChild(makeCardEl(dealerUp,true));

  Object.keys(hands).map(Number).sort((a,b)=>a-b).forEach(s=>{
    const c=draw(); const card={r:c.r,s:c.s,shown:true}; hands[s].push(card);
    document.getElementById('hand-'+s).appendChild(makeCardEl(card,true));
  });
  const dn=draw(); hiddenDown={r:dn.r,s:dn.s,shown:false}; dealer.push(hiddenDown); dealerHand.appendChild(makeCardEl(hiddenDown,false));

  if(dealerUp.r==='A'){ showInsurance(); } else { enablePlayerActions(); }
}

function showInsurance(){
  insBox.classList.add('show');
  insYes.onclick=()=>{
    let total=0; Object.keys(hands).forEach(s=> total+=bets[s]);
    const max=total/2;
    if(balance<max) { alert('Not enough balance for insurance (half bet).'); insurances[0]=0; }
    else { balance-=max; insurances[0]=max; updateBank(); }
    insBox.classList.remove('show'); enablePlayerActions(true);
  };
  insNo.onclick=()=>{ insurances[0]=0; insBox.classList.remove('show'); enablePlayerActions(true); };
}

function enablePlayerActions(){
  dealBtn.disabled=true; clearBtn.disabled=true; rebetBtn.disabled=true;
  const anyBJ = Object.keys(hands).some(s=>handValue(hands[s])===21);
  if(anyBJ && ['A','10','J','Q','K'].includes(dealerUp.r)){
    flip(hiddenDown); settleRound(true); return;
  }
  hitBtn.disabled=false; standBtn.disabled=false; doubleBtn.disabled=false;
  banner.textContent='Your move ‚Äî Seat '+activeSeat;
}

function playerHit(seat){
  if(!hands[seat]) return;
  const c=draw(); const card={r:c.r,s:c.s,shown:true}; hands[seat].push(card);
  document.getElementById('hand-'+seat).appendChild(makeCardEl(card,true));
  playS(sDeal);
  const v=handValue(hands[seat]);
  firstAction=false; if(v>21){ banner.textContent='Seat '+seat+' busts'; seatAutoAdvance(); }
}
function playerStand(seat){ firstAction=false; seatAutoAdvance(); }
function playerDouble(seat){
  if(!firstAction) return; if(balance<bets[seat]) return alert('Not enough balance to double.');
  balance-=bets[seat]; bets[seat]*=2; updateBank(); renderStack(seat);
  const c=draw(); const card={r:c.r,s:c.s,shown:true}; hands[seat].push(card);
  document.getElementById('hand-'+seat).appendChild(makeCardEl(card,true));
  playS(sDeal); firstAction=false; seatAutoAdvance();
}
function seatAutoAdvance(){
  const order=[1,2,3,4].filter(s=>hands[s]);
  const idx=order.indexOf(activeSeat);
  for(let i=idx+1;i<order.length;i++){
    const s=order[i]; const v=handValue(hands[s]); if(v<=21){ activeSeat=s; banner.textContent='Your move ‚Äî Seat '+activeSeat; return; }
  }
  hitBtn.disabled=standBtn.disabled=doubleBtn.disabled=true;
  dealerPlay();
}
function dealerPlay(){
  banner.textContent='Dealer reveals‚Ä¶'; flip(hiddenDown); setTimeout(()=>{
    const dealerBJ = handValue(dealer)===21 && dealer.length===2;
    if(insurances[0]>0){ if(dealerBJ){ balance += insurances[0]*3; } insurances[0]=0; updateBank(); }
    if(dealerBJ){ settleRound(true); return; }
    while(handValue(dealer)<17){ const c=draw(); const card={r:c.r,s:c.s,shown:true}; dealer.push(card); dealerHand.appendChild(makeCardEl(card,true)); playS(sDeal); }
    settleRound(false);
  },450);
}
function settleRound(checkedBJ){
  const dV=handValue(dealer), dealerBJ=(dV===21 && dealer.length===2);
  let totalWin=0;
  [1,2,3,4].forEach(seat=>{
    if(!hands[seat]) return;
    const v=handValue(hands[seat]); let win=0;
    if(v>21){ /* lost */ }
    else if(dealerBJ){
      if(v===21 && hands[seat].length===2){ win = bets[seat]; } // push refund
    }else{
      if(v===21 && hands[seat].length===2){ win = bets[seat]*2.5; }
      else if(dV>21 || v>dV){ win = bets[seat]*2; }
      else if(v===dV){ win = bets[seat]; }
    }
    if(win>0){ totalWin += (win - 0); balance += win; }
  });

  banner.textContent = (dealerBJ ? 'Dealer Blackjack' : ('Dealer: '+dV)) + ' ‚Äî Round settled';
  lastRes = totalWin - 0; updateBank();
  if(totalWin>0){ codeBox.style.display='block'; codeBox.textContent=CODE; copyBtn.style.display='inline-block'; playS(sWin); confetti(); try{ localStorage.setItem(CLAIM_KEY, JSON.stringify({code:CODE,ts:Date.now()})); }catch(e){} }
  else{ codeBox.style.display='block'; codeBox.textContent='TRY-AGAIN-NEXT-TIME'; }

  try{ localStorage.setItem('bj_lastbets', JSON.stringify(bets)); }catch(e){}
  inRound=false; firstAction=true;
  dealBtn.disabled=true; clearBtn.disabled=false; rebetBtn.disabled=false; hitBtn.disabled=standBtn.disabled=doubleBtn.disabled=true;
  [1,2,3,4].forEach(s=>{ bets[s]=0; renderStack(s); });

  if(cutReached){ reshuffleBtn.style.display='inline-block'; }
}
function doRebet(){
  if(inRound) return;
  try{
    const last=JSON.parse(localStorage.getItem('bj_lastbets'))||[0,0,0,0,0];
    const need=last[1]+last[2]+last[3]+last[4];
    if(need===0) return;
    if(balance<need) return alert('Not enough balance to rebet.');
    balance-=need; [1,2,3,4].forEach(s=>{ bets[s]=last[s]||0; renderStack(s); }); updateBank();
    dealBtn.disabled=false; clearBtn.disabled=false;
  }catch(e){}
}
function clearTable(){
  if(inRound) return;
  balance+=totalBet(); [1,2,3,4].forEach(s=>{ bets[s]=0; renderStack(s); }); updateBank();
  dealBtn.disabled=true; clearBtn.disabled=true;
}

/* INIT */
function priorClaim(){ try{ const p=localStorage.getItem(CLAIM_KEY); if(p){ const code=(JSON.parse(p).code)||CODE; codeBox.style.display='block'; codeBox.textContent=code; copyBtn.style.display='inline-block'; } }catch(e){} }
initShoe(); updateBank(); priorClaim();
</script>
</body>
</html>
